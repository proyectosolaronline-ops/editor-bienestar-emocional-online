<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Editor â€” Bienestar Emocional</title>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@600;700;800&family=Manrope:wght@400;500;600;700&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
/* â•â• DARK THEME VARIABLES â•â• */
:root{
  --ri:#FF85C0; --mi:#A67FFF; --rp:rgba(255,133,192,.12); --mp:rgba(166,127,255,.12);
  --grad:linear-gradient(135deg,#FF85C0,#A67FFF);
  --bg:#0d0b18; --bg2:#13111f; --bg3:#181626; --surface:#1c1a2e; --surface2:#211f35;
  --card:#1c1a2e; --card2:#211f35;
  --border:rgba(255,255,255,.07); --border2:rgba(255,255,255,.12); --border-hi:rgba(166,127,255,.3);
  --text:#ede9ff; --text2:#9992bf; --text3:#5b557a;
  --ok:#34d399; --ok-bg:rgba(52,211,153,.1); --ok-border:rgba(52,211,153,.25);
  --err:#f87171; --err-bg:rgba(248,113,113,.1); --err-border:rgba(248,113,113,.25);
  --warn:#fbbf24; --warn-bg:rgba(251,191,36,.1); --warn-border:rgba(251,191,36,.25);
  --info:#60a5fa; --info-bg:rgba(96,165,250,.1);
  --mono:'DM Mono',monospace; --radius:14px; --topbar:56px; --sidebar:228px;
  --inset:0 0 0 1px rgba(255,255,255,.04) inset;
}
*{margin:0;padding:0;box-sizing:border-box;}
::-webkit-scrollbar{width:4px;height:4px;}
::-webkit-scrollbar-track{background:transparent;}
::-webkit-scrollbar-thumb{background:rgba(166,127,255,.35);border-radius:4px;}
::-webkit-scrollbar-thumb:hover{background:rgba(166,127,255,.6);}
body{font-family:'Manrope',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;overflow-x:hidden;}

/* â•â•â• LOGIN â•â•â• */
#loginScreen{position:fixed;inset:0;z-index:9999;background:var(--bg);display:flex;align-items:center;justify-content:center;overflow:hidden;}
#loginScreen.hidden{display:none;}
.l-grid{position:absolute;inset:0;background-image:linear-gradient(rgba(166,127,255,.04) 1px,transparent 1px),linear-gradient(90deg,rgba(166,127,255,.04) 1px,transparent 1px);background-size:48px 48px;pointer-events:none;}
.l-orb{position:absolute;border-radius:50%;filter:blur(100px);pointer-events:none;animation:orbFloat 10s ease-in-out infinite alternate;}
.l-orb1{width:700px;height:700px;background:rgba(166,127,255,.13);top:-250px;left:-200px;animation-duration:9s;}
.l-orb2{width:600px;height:600px;background:rgba(255,133,192,.09);bottom:-200px;right:-150px;animation-duration:13s;}
@keyframes orbFloat{to{transform:translate(60px,80px);}}
.l-card{position:relative;z-index:2;width:420px;max-width:94vw;background:rgba(28,26,46,.9);border:1px solid var(--border2);border-radius:24px;padding:2.6rem 2.4rem 2.2rem;backdrop-filter:blur(32px);box-shadow:0 40px 100px rgba(0,0,0,.6),0 0 0 1px rgba(255,255,255,.06) inset;animation:cardIn .55s cubic-bezier(.16,1,.3,1);}
@keyframes cardIn{from{opacity:0;transform:translateY(28px) scale(.97);}to{opacity:1;transform:none;}}
.l-head{text-align:center;margin-bottom:2rem;}
.l-icon{width:64px;height:64px;border-radius:18px;margin:0 auto 1rem;background:var(--grad);display:flex;align-items:center;justify-content:center;font-size:1.8rem;box-shadow:0 8px 28px rgba(166,127,255,.45);animation:iconGlow 3s ease-in-out infinite;}
@keyframes iconGlow{0%,100%{box-shadow:0 8px 28px rgba(166,127,255,.45);}50%{box-shadow:0 8px 48px rgba(166,127,255,.7);}}
.l-title{font-family:'Syne',sans-serif;font-size:1.5rem;font-weight:800;color:#fff;letter-spacing:-.02em;}
.l-sub{font-size:.8rem;color:rgba(255,255,255,.28);margin-top:.3rem;}
.l-group{margin-bottom:1rem;}
.l-label{display:block;font-size:.67rem;font-weight:700;color:rgba(255,255,255,.35);text-transform:uppercase;letter-spacing:.12em;margin-bottom:.4rem;}
.l-wrap{position:relative;}
.l-ico{position:absolute;left:.9rem;top:50%;transform:translateY(-50%);font-size:.9rem;opacity:.3;pointer-events:none;}
.l-inp{width:100%;padding:.82rem 2.6rem;background:rgba(255,255,255,.06);border:1.5px solid rgba(255,255,255,.09);border-radius:11px;font-family:'Manrope',sans-serif;font-size:.92rem;color:#fff;outline:none;transition:all .22s;}
.l-inp::placeholder{color:rgba(255,255,255,.18);}
.l-inp:focus{border-color:var(--mi);background:rgba(166,127,255,.08);box-shadow:0 0 0 3px rgba(166,127,255,.14);}
.l-inp.bad{border-color:var(--err);animation:shake .38s ease;}
@keyframes shake{0%,100%{transform:translateX(0);}20%,60%{transform:translateX(-5px);}40%,80%{transform:translateX(5px);}}
.l-eye{position:absolute;right:.85rem;top:50%;transform:translateY(-50%);background:none;border:none;cursor:pointer;font-size:.95rem;color:rgba(255,255,255,.22);transition:color .2s;}
.l-eye:hover{color:rgba(255,255,255,.55);}
.l-btn{width:100%;padding:.95rem;border:none;border-radius:12px;margin-top:.35rem;background:var(--grad);color:#fff;font-family:'Syne',sans-serif;font-size:.95rem;font-weight:700;cursor:pointer;box-shadow:0 4px 20px rgba(166,127,255,.4);transition:all .22s;}
.l-btn:hover{transform:translateY(-2px);box-shadow:0 8px 30px rgba(166,127,255,.58);}
.l-btn:disabled{opacity:.5;cursor:not-allowed;transform:none;}
.spin{display:inline-block;width:15px;height:15px;border:2.5px solid rgba(255,255,255,.3);border-top-color:#fff;border-radius:50%;animation:sp .65s linear infinite;vertical-align:middle;margin-right:.4rem;}
@keyframes sp{to{transform:rotate(360deg);}}
.l-err{background:var(--err-bg);border:1px solid var(--err-border);border-radius:9px;padding:.65rem .95rem;font-size:.8rem;color:#fca5a5;margin-top:.85rem;display:none;}
.l-err.show{display:block;animation:shake .38s ease;}
.l-att{text-align:center;font-size:.72rem;color:rgba(255,255,255,.18);margin-top:.9rem;}
.l-att b{color:var(--ri);}

/* â•â•â• APP SHELL â•â•â• */
#app{display:none;min-height:100vh;flex-direction:column;}
#app.on{display:flex;}

/* â•â•â• TOPBAR â•â•â• */
.topbar{background:var(--bg2);border-bottom:1px solid var(--border);padding:.8rem 1.6rem;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:200;height:var(--topbar);box-shadow:0 1px 0 var(--border),0 4px 20px rgba(0,0,0,.3);}
.tb-l{display:flex;align-items:center;gap:.85rem;}
.tb-logo{width:34px;height:34px;border-radius:10px;background:var(--grad);display:flex;align-items:center;justify-content:center;font-size:1rem;flex-shrink:0;box-shadow:0 4px 12px rgba(166,127,255,.35);}
.tb-brand{font-family:'Syne',sans-serif;font-size:1rem;font-weight:800;color:var(--text);}
.tb-brand span{background:var(--grad);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;}
.tb-r{display:flex;align-items:center;gap:.6rem;}
.uchip{display:flex;align-items:center;gap:.4rem;background:var(--surface);border:1px solid var(--border2);border-radius:50px;padding:.28rem .8rem .28rem .35rem;}
.uav{width:24px;height:24px;border-radius:50%;background:var(--grad);display:flex;align-items:center;justify-content:center;font-size:.7rem;color:#fff;font-weight:700;flex-shrink:0;}
.uname{font-size:.8rem;font-weight:600;color:var(--text);}
.urole{font-size:.63rem;color:var(--text3);}

/* â•â•â• SHELL / SIDEBAR â•â•â• */
.shell{display:flex;flex:1;min-height:0;}
.sidebar{width:var(--sidebar);flex-shrink:0;background:var(--bg2);border-right:1px solid var(--border);padding:1rem 0 2rem;display:flex;flex-direction:column;position:sticky;top:var(--topbar);height:calc(100vh - var(--topbar));overflow-y:auto;}
.nav-sec{padding:.6rem 1.1rem .25rem;font-size:.6rem;font-weight:700;color:var(--text3);text-transform:uppercase;letter-spacing:.14em;margin-top:.5rem;}
.nav-item{display:flex;align-items:center;gap:.65rem;padding:.65rem 1.2rem;cursor:pointer;color:var(--text2);font-size:.85rem;font-weight:500;transition:all .18s;border-left:2.5px solid transparent;user-select:none;position:relative;}
.nav-item:hover{color:var(--text);background:rgba(255,255,255,.04);}
.nav-item.on{color:#fff;background:rgba(166,127,255,.13);border-left-color:var(--mi);}
.nav-item.on::before{content:'';position:absolute;left:0;top:50%;transform:translateY(-50%);width:2.5px;height:70%;background:var(--grad);border-radius:0 2px 2px 0;}
.nav-item .ni{font-size:.95rem;width:1.25rem;text-align:center;flex-shrink:0;}

/* â•â•â• MAIN / PAGES â•â•â• */
.main{flex:1;padding:1.6rem;overflow-y:auto;min-width:0;background:var(--bg);}
.page{display:none;}
.page.on{display:block;animation:fadeUp .22s ease;}
@keyframes fadeUp{from{opacity:0;transform:translateY(7px);}to{opacity:1;transform:none;}}

/* â•â•â• BUTTONS â•â•â• */
.btn{display:inline-flex;align-items:center;gap:.4rem;padding:.52rem 1.15rem;border-radius:50px;font-family:'Manrope',sans-serif;font-size:.82rem;font-weight:600;cursor:pointer;border:none;transition:all .18s;white-space:nowrap;}
.btn-primary{background:var(--grad);color:#fff;box-shadow:0 3px 12px rgba(166,127,255,.35);}
.btn-primary:hover{transform:translateY(-1px);box-shadow:0 6px 20px rgba(166,127,255,.5);}
.btn-primary:disabled{opacity:.45;cursor:not-allowed;transform:none;}
.btn-ghost{background:transparent;color:var(--text2);border:1.5px solid var(--border2);}
.btn-ghost:hover{border-color:var(--mi);color:var(--mi);background:var(--mp);}
.btn-danger{background:var(--err-bg);color:var(--err);border:1.5px solid var(--err-border);}
.btn-danger:hover{background:var(--err);color:#fff;border-color:var(--err);}
.btn-ok{background:var(--ok-bg);color:var(--ok);border:1.5px solid var(--ok-border);}
.btn-ok:hover{background:var(--ok);color:#fff;}
.btn-warn{background:var(--warn-bg);color:var(--warn);border:1.5px solid var(--warn-border);}
.btn-warn:hover{background:var(--warn);color:#fff;}
.btn-sm{padding:.34rem .85rem;font-size:.76rem;}

/* â•â•â• CARDS â•â•â• */
.card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);overflow:hidden;margin-bottom:1.2rem;box-shadow:var(--inset);}
.card-head{padding:.95rem 1.35rem;background:linear-gradient(135deg,rgba(166,127,255,.08),rgba(255,133,192,.05));border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;gap:.5rem;flex-wrap:wrap;}
.card-title{font-family:'Syne',sans-serif;font-size:.92rem;font-weight:700;display:flex;align-items:center;gap:.5rem;color:var(--text);}
.card-body{padding:1.35rem;}

/* â•â•â• FORM ELEMENTS â•â•â• */
.fg{margin-bottom:.95rem;}
.fg:last-child{margin-bottom:0;}
.fg label{display:block;font-size:.68rem;font-weight:700;color:var(--text3);text-transform:uppercase;letter-spacing:.1em;margin-bottom:.38rem;}
input[type=text],input[type=email],input[type=tel],input[type=url],input[type=password],textarea,select{
  width:100%;padding:.68rem .9rem;border:1.5px solid var(--border2);border-radius:9px;
  font-family:'Manrope',sans-serif;font-size:.9rem;color:var(--text);
  background:var(--surface2);outline:none;transition:all .18s;
  box-shadow:0 1px 3px rgba(0,0,0,.2) inset;
}
input:focus,textarea:focus,select:focus{border-color:var(--mi);background:rgba(166,127,255,.08);box-shadow:0 0 0 3px rgba(166,127,255,.13);}
input::placeholder,textarea::placeholder{color:var(--text3);}
select option{background:var(--surface2);color:var(--text);}
textarea{min-height:82px;resize:vertical;line-height:1.58;}
.hint{font-size:.7rem;color:var(--text3);margin-top:.28rem;}
.g2{display:grid;grid-template-columns:1fr 1fr;gap:.85rem;}
.g3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:.85rem;}

/* â•â•â• TOGGLE â•â•â• */
.trow{display:flex;align-items:center;gap:.65rem;margin-bottom:.75rem;}
.tog{position:relative;width:40px;height:22px;flex-shrink:0;}
.tog input{opacity:0;width:0;height:0;position:absolute;}
.tog-sl{position:absolute;inset:0;border-radius:50px;background:var(--surface2);border:1.5px solid var(--border2);cursor:pointer;transition:.28s;}
.tog-sl::before{content:'';position:absolute;width:15px;height:15px;left:2px;top:50%;transform:translateY(-50%);background:var(--text3);border-radius:50%;transition:.28s;box-shadow:0 1px 4px rgba(0,0,0,.3);}
.tog input:checked+.tog-sl{background:var(--grad);border-color:transparent;}
.tog input:checked+.tog-sl::before{transform:translateX(18px) translateY(-50%);background:#fff;}
.tog-lbl{font-size:.85rem;font-weight:600;color:var(--text);}

/* â•â•â• DYN LISTS â•â•â• */
.dyn{display:flex;flex-direction:column;gap:.4rem;margin-bottom:.45rem;}
.dyn-row{display:flex;gap:.38rem;align-items:center;}
.dyn-row input{flex:1;}
.dyn-rm{padding:.6rem .68rem;border:none;border-radius:8px;background:var(--err-bg);color:var(--err);border:1px solid var(--err-border);cursor:pointer;transition:all .18s;flex-shrink:0;font-size:.88rem;line-height:1;}
.dyn-rm:hover{background:var(--err);color:#fff;border-color:var(--err);}
.dyn-add{display:flex;align-items:center;gap:.38rem;padding:.5rem .9rem;border-radius:8px;border:1.5px dashed rgba(166,127,255,.4);background:none;color:var(--mi);font-family:'Manrope',sans-serif;font-size:.8rem;font-weight:600;cursor:pointer;transition:all .18s;}
.dyn-add:hover{background:var(--mp);border-color:var(--mi);}

/* â•â•â• DIVIDER â•â•â• */
.div{display:flex;align-items:center;gap:.7rem;margin:1rem 0 .8rem;}
.div span{font-size:.65rem;font-weight:700;color:var(--text3);text-transform:uppercase;letter-spacing:.12em;white-space:nowrap;}
.div::before,.div::after{content:'';flex:1;height:1px;background:var(--border);}

/* â•â•â• BADGES â•â•â• */
.badge{display:inline-flex;align-items:center;gap:.28rem;padding:.18rem .65rem;border-radius:50px;font-size:.7rem;font-weight:700;white-space:nowrap;}
.badge-ok{background:var(--ok-bg);color:var(--ok);border:1px solid var(--ok-border);}
.badge-warn{background:var(--warn-bg);color:var(--warn);border:1px solid var(--warn-border);}
.badge-err{background:var(--err-bg);color:var(--err);border:1px solid var(--err-border);}
.badge-info{background:var(--info-bg);color:var(--info);}

/* â•â•â• SKELETON â•â•â• */
.skel{background:linear-gradient(90deg,var(--surface) 25%,var(--surface2) 50%,var(--surface) 75%);background-size:200% 100%;animation:skelMove 1.5s infinite;border-radius:7px;height:17px;margin-bottom:.45rem;}
@keyframes skelMove{0%{background-position:200% 0;}100%{background-position:-200% 0;}}

/* â•â•â• IMAGE UPLOADER â•â•â• */
.img-uploader{border:2px dashed var(--border2);border-radius:11px;overflow:hidden;transition:border-color .2s;background:var(--surface);}
.img-uploader.drag-over{border-color:var(--mi);background:var(--mp);}
.img-drop-label{display:block;padding:1.3rem;text-align:center;cursor:pointer;}
.img-drop-label input[type=file]{display:none;}
.img-drop-icon{font-size:1.9rem;margin-bottom:.38rem;opacity:.45;pointer-events:none;}
.img-drop-text{font-size:.78rem;color:var(--text2);font-weight:500;pointer-events:none;}
.img-drop-text b{color:var(--mi);}
.img-drop-text small{display:block;font-size:.68rem;margin-top:.18rem;color:var(--text3);}
.img-preview-wrap{display:none;position:relative;overflow:hidden;}
.img-preview-wrap.show{display:block;}
.img-preview-wrap img{width:100%;height:170px;object-fit:contain;display:block;background:var(--surface2);}
.img-preview-overlay{position:absolute;inset:0;background:rgba(13,11,24,.6);display:flex;align-items:center;justify-content:center;gap:.55rem;opacity:0;transition:opacity .2s;}
.img-preview-wrap:hover .img-preview-overlay{opacity:1;}
.img-progress{height:3px;background:var(--surface2);}
.img-progress-bar{height:100%;background:var(--grad);width:0%;transition:width .28s;}
.img-status{padding:.45rem .85rem;font-size:.72rem;font-weight:600;display:none;align-items:center;gap:.38rem;border-top:1px solid var(--border);background:var(--surface);}
.img-status.show{display:flex;}
.img-saved-url{display:none;align-items:center;gap:.45rem;padding:.45rem .85rem;font-size:.7rem;background:var(--ok-bg);border-top:1px solid var(--ok-border);color:var(--ok);flex-wrap:wrap;}
.img-saved-url.show{display:flex;}
.img-saved-url a{color:var(--ok);text-decoration:underline;word-break:break-all;}
.img-blocked-ph{padding:.9rem;text-align:center;font-size:.75rem;color:var(--text2);background:var(--surface2);}

/* â•â•â• PREVIEW BOX â•â•â• */
.preview-box{border:1.5px solid var(--border2);border-radius:11px;overflow:hidden;}
.pb-head{padding:.9rem 1.1rem;background:var(--grad);color:#fff;font-family:'Syne',sans-serif;font-weight:700;font-size:.92rem;}
.pb-body{padding:1.1rem;background:var(--surface2);font-size:.86rem;line-height:1.62;color:var(--text);}
.pb-body img{width:100%;max-height:150px;object-fit:cover;border-radius:7px;margin-bottom:.75rem;display:block;}
.pb-badge{display:inline-block;background:var(--grad);color:#fff;font-size:.68rem;font-weight:700;padding:.18rem .6rem;border-radius:50px;margin-bottom:.55rem;text-transform:uppercase;}
.pb-section{font-weight:700;color:var(--mi);background:var(--mp);padding:.35rem .75rem;border-radius:6px;margin:.65rem 0 .4rem;display:block;font-size:.8rem;border-left:3px solid var(--mi);}
.pb-cta{display:block;text-align:center;background:var(--grad);color:#fff;padding:.62rem;border-radius:50px;font-weight:700;font-size:.83rem;text-decoration:none;margin-top:.75rem;}

/* â•â•â• INFO BOX â•â•â• */
.info-box{background:linear-gradient(135deg,rgba(166,127,255,.09),rgba(255,133,192,.06));border:1px solid var(--border-hi);border-radius:9px;padding:.75rem .95rem;font-size:.8rem;color:var(--text2);margin-bottom:1.1rem;}
.info-box b{color:var(--mi);}

/* â•â•â• USERS TABLE â•â•â• */
.utbl{width:100%;border-collapse:collapse;font-size:.85rem;}
.utbl th{padding:.55rem .85rem;text-align:left;font-size:.67rem;color:var(--text3);text-transform:uppercase;letter-spacing:.1em;border-bottom:1px solid var(--border2);}
.utbl td{padding:.78rem .85rem;border-bottom:1px solid var(--border);vertical-align:middle;color:var(--text);}
.utbl tr:last-child td{border-bottom:none;}
.utbl tr:hover td{background:rgba(255,255,255,.02);}
.role-chip{padding:.18rem .6rem;border-radius:50px;font-size:.7rem;font-weight:700;}
.role-admin{background:var(--mp);color:var(--mi);}
.role-editor{background:var(--rp);color:var(--ri);}
.role-viewer{background:rgba(255,255,255,.06);color:var(--text2);}
.status-dot{width:7px;height:7px;border-radius:50%;display:inline-block;margin-right:.28rem;vertical-align:middle;}

/* â•â•â• TOASTS â•â•â• */
.toasts{position:fixed;bottom:1.4rem;right:1.4rem;display:flex;flex-direction:column;gap:.5rem;z-index:9999;pointer-events:none;}
.toast{background:var(--surface2);color:var(--text);padding:.75rem 1.2rem;border-radius:11px;font-size:.83rem;font-weight:600;display:flex;align-items:center;gap:.55rem;box-shadow:0 8px 28px rgba(0,0,0,.5),0 0 0 1px var(--border2);max-width:320px;animation:toastIn .28s ease;pointer-events:auto;border-left:3px solid transparent;}
@keyframes toastIn{from{opacity:0;transform:translateX(44px);}to{opacity:1;transform:none;}}

/* â•â•â• MODALS â•â•â• */
.overlay-modal{display:none;position:fixed;inset:0;z-index:5000;background:rgba(7,5,18,.88);backdrop-filter:blur(10px);align-items:center;justify-content:center;}
.overlay-modal.show{display:flex;}
.om-box{background:var(--card);border:1px solid var(--border2);border-radius:18px;padding:1.8rem 1.7rem;width:440px;max-width:95vw;box-shadow:0 24px 60px rgba(0,0,0,.6),0 0 0 1px rgba(255,255,255,.06) inset;animation:cardIn .28s ease;position:relative;max-height:90vh;overflow-y:auto;}
.om-close{position:absolute;right:1.1rem;top:1.1rem;background:var(--surface2);border:1px solid var(--border);width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:.9rem;cursor:pointer;color:var(--text2);transition:all .18s;}
.om-close:hover{background:var(--err-bg);color:var(--err);border-color:var(--err-border);}
.om-title{font-family:'Syne',sans-serif;font-size:1.1rem;font-weight:800;color:var(--text);margin-bottom:1.3rem;}
.strength-bar{height:3px;border-radius:2px;margin-top:.38rem;transition:all .28s;background:var(--border2);}

/* â•â•â• VISIBILIDAD â•â•â• */
.vis-row{display:flex;align-items:center;gap:.9rem;padding:.85rem 1rem;border-radius:11px;border:1.5px solid var(--border);background:var(--surface);transition:all .2s;cursor:default;}
.vis-row:hover{border-color:var(--border-hi);}
.vis-row.vis-off{opacity:.55;border-color:var(--err-border);background:rgba(248,113,113,.05);}
.vis-ico{font-size:1.3rem;width:1.9rem;text-align:center;flex-shrink:0;}
.vis-info{flex:1;min-width:0;}
.vis-label{font-weight:700;font-size:.86rem;color:var(--text);}
.vis-desc{font-size:.72rem;color:var(--text3);margin-top:.12rem;}
.vis-tog{flex-shrink:0;}

/* â•â•â• PENDIENTES â•â•â• */
.pend-filtros{display:flex;gap:.45rem;flex-wrap:wrap;margin-bottom:1.1rem;}
.pend-filtro{padding:.32rem .95rem;border-radius:50px;border:1.5px solid var(--border2);background:var(--surface);font-family:'Manrope',sans-serif;font-size:.76rem;font-weight:600;color:var(--text2);cursor:pointer;transition:all .18s;}
.pend-filtro.on,.pend-filtro:hover{background:var(--grad);color:#fff;border-color:transparent;box-shadow:0 3px 10px rgba(166,127,255,.3);}
.pend-filtro .n{opacity:.7;margin-left:2px;}
.pend-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(290px,1fr));gap:.9rem;}
.pend-card{background:var(--card);border:1.5px solid var(--border);border-radius:14px;overflow:hidden;transition:all .2s;cursor:pointer;}
.pend-card:hover{transform:translateY(-2px);box-shadow:0 8px 28px rgba(0,0,0,.4);border-color:var(--border-hi);}
.pend-card-hdr{padding:.9rem 1rem .7rem;display:flex;align-items:flex-start;justify-content:space-between;gap:.45rem;}
.pend-card-nombre{font-family:'Syne',sans-serif;font-size:.92rem;font-weight:700;color:var(--text);}
.pend-card-id{font-size:.65rem;color:var(--text3);font-family:var(--mono);margin-top:2px;}
.pend-card-body{padding:0 1rem .85rem;font-size:.8rem;color:var(--text2);line-height:1.62;}
.pend-card-body strong{color:var(--text);font-weight:600;}
.pend-card-footer{padding:.65rem 1rem;background:var(--surface);border-top:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;gap:.45rem;}
.pend-card-ts{font-size:.67rem;color:var(--text3);}
.pend-chip{display:inline-flex;align-items:center;gap:.22rem;padding:.16rem .6rem;border-radius:50px;font-size:.68rem;font-weight:700;}
.chip-pendiente{background:var(--warn-bg);color:var(--warn);}
.chip-espera{background:var(--info-bg);color:var(--info);}
.chip-confirmado{background:var(--ok-bg);color:var(--ok);}
.chip-cancelado{background:var(--err-bg);color:var(--err);}
.pend-empty{text-align:center;padding:3.5rem 1rem;color:var(--text3);}
.pend-empty-ico{font-size:2.8rem;margin-bottom:.65rem;opacity:.35;}
.pend-empty p{font-size:.86rem;}

/* â•â•â• AGENDA MODAL â•â•â• */
#agendaModal .om-box{width:620px;max-width:96vw;}
.agenda-context{background:linear-gradient(135deg,var(--mp),var(--rp));border:1.5px solid var(--border-hi);border-radius:11px;padding:.95rem 1rem;margin-bottom:1.2rem;}
.agenda-context-nombre{font-family:'Syne',sans-serif;font-size:.98rem;font-weight:800;color:var(--text);margin-bottom:.18rem;}
.agenda-context-info{font-size:.78rem;color:var(--text2);display:flex;flex-wrap:wrap;gap:.35rem .75rem;margin-top:.28rem;}
.agenda-slots-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:.55rem;margin-bottom:1rem;max-height:220px;overflow-y:auto;padding-right:2px;}
.agenda-slot{background:var(--surface);border:1.5px solid var(--border2);border-radius:11px;padding:.65rem .55rem;text-align:center;cursor:pointer;transition:all .18s;}
.agenda-slot:hover,.agenda-slot.sel{background:var(--grad);border-color:transparent;color:#fff;}
.agenda-slot:hover .asl-dia,.agenda-slot.sel .asl-dia,
.agenda-slot:hover .asl-fecha,.agenda-slot.sel .asl-fecha,
.agenda-slot:hover .asl-hora,.agenda-slot.sel .asl-hora{color:#fff!important;}
.asl-dia{font-size:.6rem;font-weight:700;color:var(--text3);text-transform:uppercase;letter-spacing:.07em;}
.asl-fecha{font-family:'Syne',sans-serif;font-size:1.15rem;font-weight:800;color:var(--text);line-height:1.1;}
.asl-mes{font-size:.62rem;color:var(--text3);}
.asl-hora{font-size:.7rem;font-weight:700;color:var(--mi);margin-top:.28rem;}
.slot-loading{text-align:center;padding:2rem;color:var(--text2);font-size:.82rem;}
.slot-spinner{width:26px;height:26px;border:3px solid var(--mp);border-top-color:var(--mi);border-radius:50%;animation:sp .65s linear infinite;margin:0 auto .55rem;}
.notif-section{background:var(--surface);border:1.5px solid var(--border);border-radius:11px;padding:.95rem 1rem;}
.notif-title{font-size:.68rem;font-weight:700;color:var(--text3);text-transform:uppercase;letter-spacing:.1em;margin-bottom:.65rem;}
.notif-checks{display:flex;flex-direction:column;gap:.45rem;}
.notif-check{display:flex;align-items:flex-start;gap:.65rem;cursor:pointer;}
.notif-check input[type=checkbox]{width:15px;height:15px;margin-top:2px;accent-color:var(--mi);flex-shrink:0;}
.notif-check-txt{font-size:.8rem;color:var(--text);}
.notif-check-txt small{display:block;font-size:.7rem;color:var(--text3);margin-top:1px;}
.notif-msg{width:100%;margin-top:.55rem;padding:.62rem .88rem;border:1.5px solid var(--border2);border-radius:9px;font-size:.8rem;font-family:'Manrope',sans-serif;color:var(--text);background:var(--surface2);resize:vertical;min-height:65px;outline:none;transition:border .18s;}
.notif-msg:focus{border-color:var(--mi);}

/* â•â•â• COLOR PICKER â•â•â• */
input[type=color]{cursor:pointer;padding:2px;border-radius:7px;background:transparent;border:1.5px solid var(--border2);}

/* â•â•â• AGENDA FLOAT BTN â•â•â• */
.agenda-float{position:fixed;bottom:1.4rem;left:1.4rem;z-index:9000;background:var(--grad);color:#fff;border:none;border-radius:50px;padding:.7rem 1.3rem;font-family:'Syne',sans-serif;font-size:.85rem;font-weight:700;cursor:pointer;box-shadow:0 4px 18px rgba(166,127,255,.5);transition:all .22s;display:flex;align-items:center;gap:.45rem;}
.agenda-float:hover{transform:translateY(-3px);box-shadow:0 8px 26px rgba(166,127,255,.68);}

/* â•â•â• VIS PREVIEW IFRAME â•â•â• */
.vis-preview-frame{border:1.5px solid var(--border);border-radius:11px;overflow:hidden;background:var(--surface);margin-top:.8rem;}
.vis-preview-frame-bar{padding:.55rem .9rem;background:var(--surface2);border-bottom:1px solid var(--border);display:flex;align-items:center;gap:.5rem;font-size:.72rem;color:var(--text3);}
.vis-preview-frame-bar .dot{width:8px;height:8px;border-radius:50%;background:var(--mi);}

/* â•â•â• RESPONSIVE â•â•â• */
@media(max-width:768px){
  .shell{flex-direction:column;}
  .sidebar{width:100%;height:auto;position:static;flex-direction:row;overflow-x:auto;padding:.4rem;border-right:none;border-bottom:1px solid var(--border);}
  .nav-sec{display:none;}
  .nav-item{padding:.45rem .85rem;border-left:none;border-bottom:2.5px solid transparent;font-size:.78rem;white-space:nowrap;}
  .nav-item.on{border-left:none;border-bottom-color:var(--mi);}
  .nav-item.on::before{display:none;}
  .g2,.g3{grid-template-columns:1fr;}
  .main{padding:.9rem;}
  #modal-layout{grid-template-columns:1fr!important;}
  #modal-preview-col{display:none;}
  .pend-grid{grid-template-columns:1fr;}
}
</style>
</head>
<body>

<!-- â•â• LOGIN â•â• -->
<div id="loginScreen">
  <div class="l-grid"></div>
  <div class="l-orb l-orb1"></div>
  <div class="l-orb l-orb2"></div>
  <div class="l-card">
    <div class="l-head">
      <div class="l-icon">âœï¸</div>
      <div class="l-title">Editor de contenido</div>
      <div class="l-sub">Bienestar Emocional Â· Acceso restringido</div>
    </div>
    <div class="l-group">
      <label class="l-label">Usuario</label>
      <div class="l-wrap"><span class="l-ico">ğŸ‘¤</span><input class="l-inp" type="text" id="lu" placeholder="tu usuario" autocomplete="username" onkeydown="if(event.key==='Enter')doLogin()"></div>
    </div>
    <div class="l-group">
      <label class="l-label">ContraseÃ±a</label>
      <div class="l-wrap">
        <span class="l-ico">ğŸ”’</span>
        <input class="l-inp" type="password" id="lp" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" autocomplete="current-password" onkeydown="if(event.key==='Enter')doLogin()">
        <button class="l-eye" type="button" onclick="togglePwd('lp',this)">ğŸ‘</button>
      </div>
    </div>
    <button class="l-btn" id="lbtn" onclick="doLogin()">Entrar al editor</button>
    <div class="l-err" id="lerr"></div>
    <div class="l-att">Intentos restantes: <b id="latt">5</b></div>
  </div>
</div>

<!-- â•â• APP â•â• -->
<div id="app">
  <div class="topbar">
    <div class="tb-l">
      <div class="tb-logo">âœï¸</div>
      <div class="tb-brand">Editor <span>Bienestar Emocional</span></div>
    </div>
    <div class="tb-r">
      <div class="uchip">
        <div class="uav" id="uav">A</div>
        <div><div class="uname" id="uname">â€”</div><div class="urole" id="urole">â€”</div></div>
      </div>
      <button class="btn btn-danger btn-sm" onclick="doLogout()">ğŸšª Salir</button>
    </div>
  </div>

  <div class="shell">
    <nav class="sidebar">
      <div class="nav-sec">Contenido</div>
      <div class="nav-item on" id="nav-config"       onclick="goTo('config',this)">      <span class="ni">âš™ï¸</span>Configuracion</div>
      <div class="nav-item"    id="nav-contacto"     onclick="goTo('contacto',this)">    <span class="ni">ğŸ“</span>Contacto</div>
      <div class="nav-item"    id="nav-mapa"         onclick="goTo('mapa',this)">        <span class="ni">ğŸ“</span>Mapa</div>
      <div class="nav-sec">Servicios</div>
      <div class="nav-item"    id="nav-Empresas"     onclick="goTo('Empresas',this)">    <span class="ni">ğŸ¢</span>Empresas</div>
      <div class="nav-item"    id="nav-Escuelas"     onclick="goTo('Escuelas',this)">    <span class="ni">ğŸ«</span>Escuelas</div>
      <div class="nav-item"    id="nav-Infantil"     onclick="goTo('Infantil',this)">    <span class="ni">ğŸ‘¶</span>NiÃ±os y Adolescentes</div>
      <div class="nav-item"    id="nav-Adultos"      onclick="goTo('Adultos',this)">     <span class="ni">ğŸ‘±</span>Adultos</div>
      <div class="nav-item"    id="nav-Evaluaciones" onclick="goTo('Evaluaciones',this)"><span class="ni">ğŸ§ </span>Evaluaciones</div>
      <div class="nav-sec">Apariencia</div>
      <div class="nav-item"    id="nav-colores"      onclick="goTo('colores',this)">     <span class="ni">ğŸ¨</span>Colores del sitio</div>
      <div class="nav-item"    id="nav-visibilidad"  onclick="goTo('visibilidad',this)"> <span class="ni">ğŸ‘ï¸</span>Visibilidad</div>
      <div class="nav-sec">Administracion</div>
      <div class="nav-item"    id="nav-pendientes"   onclick="goTo('pendientes',this)">
        <span class="ni">ğŸ“‹</span>Pendientes
        <span id="pend-nav-badge" style="display:none;background:var(--grad);color:#fff;border-radius:50px;padding:1px 7px;font-size:.62rem;font-weight:800;margin-left:auto;line-height:1.6;"></span>
      </div>
      <div class="nav-item"    id="nav-usuarios"     onclick="goTo('usuarios',this)">    <span class="ni">ğŸ‘¥</span>Usuarios</div>
    </nav>

    <div class="main">

      <!-- â•â• CONFIG â•â• -->
      <div class="page on" id="page-config">
        <div class="card">
          <div class="card-head">
            <div class="card-title">âš™ï¸ Configuracion general del sitio</div>
            <button class="btn btn-primary btn-sm save-btn" onclick="saveTab('Config')">ğŸ’¾ Guardar cambios</button>
          </div>
          <div class="card-body">
            <div id="cfg-loading"><div class="skel" style="height:20px;width:50%;"></div><div class="skel"></div><div class="skel" style="width:80%;"></div></div>
            <div id="cfg-form" style="display:none;">
              <div class="div"><span>Header del sitio</span></div>
              <div class="fg"><label>Titulo principal (H1)</label><input type="text" id="cfg-titulo"></div>
              <div class="g2">
                <div class="fg"><label>Subtitulo linea 1</label><input type="text" id="cfg-subtitulo1"></div>
                <div class="fg"><label>Subtitulo linea 2</label><input type="text" id="cfg-subtitulo2"></div>
              </div>
              <div class="fg">
                <label>Logo del sitio</label>
                <div class="img-uploader" id="up-logo">
                  <label class="img-drop-label" id="drop-logo"><input type="file" id="file-logo" accept="image/jpeg,image/png,image/webp,image/gif"><div class="img-drop-icon">ğŸ–¼ï¸</div><div class="img-drop-text"><b>Haz clic aqui</b> para seleccionar el logo<small>JPG, PNG, WEBP â€” max. 5 MB</small></div></label>
                  <div class="img-preview-wrap" id="prev-logo"><img src="" alt="preview logo"><div class="img-preview-overlay"><button type="button" class="btn btn-ghost btn-sm" onclick="clearImg('logo')">ğŸ—‘ Quitar</button><label class="btn btn-primary btn-sm" style="cursor:pointer;" for="file-logo">ğŸ”„ Cambiar</label></div></div>
                  <div class="img-progress"><div class="img-progress-bar" id="prog-logo"></div></div>
                  <div class="img-status" id="stat-logo"></div>
                  <div class="img-saved-url" id="saved-logo">âœ… Guardado en Drive: <a id="saved-logo-link" href="#" target="_blank">Ver archivo</a></div>
                </div>
                <input type="hidden" id="cfg-logo_url">
              </div>
              <div class="div"><span>Seccion Hero</span></div>
              <div class="fg"><label>Titulo hero</label><input type="text" id="cfg-hero_titulo"></div>
              <div class="fg"><label>Descripcion hero</label><textarea id="cfg-hero_descripcion"></textarea></div>
              <div class="div"><span>Quienes somos</span></div>
              <div class="fg"><label>Titulo</label><input type="text" id="cfg-quienes_titulo"></div>
              <div class="fg"><label>Texto</label><textarea id="cfg-quienes_texto" style="min-height:105px;"></textarea></div>
              <div class="fg">
                <label>Imagen â€” Quienes somos</label>
                <div class="img-uploader" id="up-quienes">
                  <label class="img-drop-label" id="drop-quienes"><input type="file" id="file-quienes" accept="image/jpeg,image/png,image/webp,image/gif"><div class="img-drop-icon">ğŸ“¸</div><div class="img-drop-text"><b>Haz clic aqui</b> para seleccionar imagen<small>JPG, PNG, WEBP â€” max. 5 MB</small></div></label>
                  <div class="img-preview-wrap" id="prev-quienes"><img src="" alt="preview quienes"><div class="img-preview-overlay"><button type="button" class="btn btn-ghost btn-sm" onclick="clearImg('quienes')">ğŸ—‘ Quitar</button><label class="btn btn-primary btn-sm" style="cursor:pointer;" for="file-quienes">ğŸ”„ Cambiar</label></div></div>
                  <div class="img-progress"><div class="img-progress-bar" id="prog-quienes"></div></div>
                  <div class="img-status" id="stat-quienes"></div>
                  <div class="img-saved-url" id="saved-quienes">âœ… Guardado en Drive: <a id="saved-quienes-link" href="#" target="_blank">Ver archivo</a></div>
                </div>
                <input type="hidden" id="cfg-quienes_imagen">
              </div>
              <div class="div"><span>Pie de pagina</span></div>
              <div class="fg"><label>Texto de copyright</label><input type="text" id="cfg-footer_texto"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- â•â• CONTACTO â•â• -->
      <div class="page" id="page-contacto">
        <div class="card"><div class="card-head"><div class="card-title">ğŸ“ Contacto &amp; Redes</div><button class="btn btn-primary btn-sm save-btn" onclick="saveTab('Contacto')">ğŸ’¾ Guardar cambios</button></div>
          <div class="card-body">
            <div id="ctc-loading"><div class="skel" style="height:20px;width:50%;"></div><div class="skel"></div></div>
            <div id="ctc-form" style="display:none;">
              <div class="g3">
                <div class="fg"><label>Telefono / WhatsApp</label><input type="tel" id="ctc-telefono" placeholder="4425839311"><div class="hint">Solo numeros, sin espacios.</div></div>
                <div class="fg"><label>Correo electronico</label><input type="email" id="ctc-correo"></div>
                <div class="fg"><label>Horario de atencion</label><input type="text" id="ctc-horario"></div>
              </div>
              <div class="div"><span>Redes sociales</span></div>
              <div class="g2">
                <div class="fg"><label>URL Facebook</label><input type="url" id="ctc-facebook"></div>
                <div class="fg"><label>URL Instagram</label><input type="url" id="ctc-instagram"></div>
              </div>
              <div class="div"><span>WhatsApp</span></div>
              <div class="fg"><label>Mensaje inicial de WhatsApp</label><textarea id="ctc-whatsapp_mensaje"></textarea></div>
            </div>
          </div>
        </div>
      </div>

      <!-- â•â• MAPA â•â• -->
      <div class="page" id="page-mapa">
        <div class="card"><div class="card-head"><div class="card-title">ğŸ“ Ubicacion &amp; Mapa</div><button class="btn btn-primary btn-sm save-btn" onclick="saveTab('Mapa')">ğŸ’¾ Guardar cambios</button></div>
          <div class="card-body">
            <div id="map-loading"><div class="skel" style="height:20px;width:50%;"></div><div class="skel"></div></div>
            <div id="map-form" style="display:none;">
              <div class="g2">
                <div class="fg"><label>Latitud</label><input type="text" id="map-latitud" placeholder="20.581839" oninput="buildEmbedFromCoords()"></div>
                <div class="fg"><label>Longitud</label><input type="text" id="map-longitud" placeholder="-100.417727" oninput="buildEmbedFromCoords()"></div>
              </div>
              <div id="map-coords-preview" style="display:none;margin-bottom:1.1rem;border:1.5px solid var(--border);border-radius:11px;overflow:hidden;">
                <iframe id="map-iframe" src="" width="100%" height="250" style="display:block;border:none;" loading="lazy" allowfullscreen></iframe>
              </div>
              <div class="fg"><label>Texto del boton</label><input type="text" id="map-boton_texto" placeholder="Como llegar aqui"></div>
              <div class="fg"><label>src del iframe (avanzado)</label><textarea id="map-embed_url" style="min-height:52px;font-size:.76rem;" oninput="previewMapEmbed()"></textarea></div>
              <input type="hidden" id="map-link_directo">
            </div>
          </div>
        </div>
      </div>

      <!-- â•â• MODAL SERVICIOS â•â• -->
      <div class="page" id="page-modal">
        <div class="card">
          <div class="card-head">
            <div class="card-title" id="modal-card-title">ğŸ¢ Servicio</div>
            <div style="display:flex;gap:.45rem;align-items:center;flex-wrap:wrap;">
              <span class="badge badge-warn" id="modal-status">Sin cargar</span>
              <button class="btn btn-ghost btn-sm" onclick="loadCurrentModal()">â†º Recargar</button>
              <button class="btn btn-primary btn-sm save-btn" onclick="saveCurrentModal()">ğŸ’¾ Guardar cambios</button>
            </div>
          </div>
          <div class="card-body">
            <div id="modal-loading" style="padding:1.8rem 0;"><div class="skel" style="height:20px;width:60%;margin-bottom:.9rem;"></div><div class="skel"></div><div class="skel" style="width:90%;"></div></div>
            <div id="modal-form" style="display:none;">
              <div id="modal-layout" style="display:grid;grid-template-columns:1fr 310px;gap:1.3rem;align-items:start;">
                <div>
                  <div class="div"><span>Informacion general</span></div>
                  <div class="fg"><label>Titulo del modal</label><input type="text" id="m-titulo" oninput="updatePreview()"></div>
                  <div class="fg"><label>Introduccion / descripcion</label><textarea id="m-intro" style="min-height:95px;" oninput="updatePreview()"></textarea></div>
                  <div class="fg">
                    <label>Imagen del servicio</label>
                    <div class="img-uploader" id="up-modal">
                      <label class="img-drop-label" id="drop-modal"><input type="file" id="file-modal" accept="image/jpeg,image/png,image/webp,image/gif"><div class="img-drop-icon">ğŸ“·</div><div class="img-drop-text"><b>Haz clic aqui</b> para seleccionar imagen<small>JPG, PNG, WEBP â€” max. 5 MB</small></div></label>
                      <div class="img-preview-wrap" id="prev-modal"><img src="" alt="preview modal"><div class="img-preview-overlay"><button type="button" class="btn btn-ghost btn-sm" onclick="clearImg('modal')">ğŸ—‘ Quitar</button><label class="btn btn-primary btn-sm" style="cursor:pointer;" for="file-modal">ğŸ”„ Cambiar</label></div></div>
                      <div class="img-progress"><div class="img-progress-bar" id="prog-modal"></div></div>
                      <div class="img-status" id="stat-modal"></div>
                      <div class="img-saved-url" id="saved-modal">âœ… Guardado en Drive: <a id="saved-modal-link" href="#" target="_blank">Ver archivo</a></div>
                    </div>
                    <input type="hidden" id="m-imagen">
                  </div>
                  <div class="fg"><label>Badge (vacio para ocultar)</label><input type="text" id="m-badge" placeholder="Ej: Nuevo" oninput="updatePreview()"></div>
                  <div class="div"><span>Servicios ofrecidos</span></div>
                  <div class="fg"><label>Titulo de la seccion</label><input type="text" id="m-servicios_titulo" oninput="updatePreview()" placeholder="Nuestros servicios:"></div>
                  <div class="dyn" id="m-svc-list"></div>
                  <button class="dyn-add" type="button" onclick="addDynItem('svc')">+ Agregar servicio</button>
                  <div class="div" style="margin-top:1.1rem;"><span>Temas / areas</span></div>
                  <div class="fg"><label>Titulo de la seccion</label><input type="text" id="m-temas_titulo" oninput="updatePreview()" placeholder="Temas que abordamos:"></div>
                  <div class="dyn" id="m-tema-list"></div>
                  <button class="dyn-add" type="button" onclick="addDynItem('tema')">+ Agregar tema</button>
                  <div class="div" style="margin-top:1.1rem;"><span>CTA &amp; Modalidad</span></div>
                  <div class="g2">
                    <div class="fg"><label>Texto del boton</label><input type="text" id="m-cta_texto" oninput="updatePreview()" placeholder="Contactar"></div>
                    <div class="fg"><label>URL del boton</label><input type="url" id="m-cta_url" placeholder="https://wa.me/..."></div>
                  </div>
                  <div class="fg"><label>Modalidad de atencion</label><input type="text" id="m-modalidad" placeholder="Presencial y en linea"></div>
                </div>
                <div id="modal-preview-col" style="position:sticky;top:72px;">
                  <div class="card" style="margin-bottom:0;"><div class="card-head" style="padding:.65rem .95rem;"><div class="card-title" style="font-size:.8rem;">ğŸ‘ Vista previa</div></div>
                    <div class="card-body" style="padding:.75rem;">
                      <div class="preview-box"><div class="pb-head" id="pv-head">Titulo</div><div class="pb-body" id="pv-body"><p style="color:var(--text3);font-size:.8rem;">Completa los campos para ver la vista previa.</p></div></div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- â•â• COLORES â•â• -->
      <div class="page" id="page-colores">
        <div class="card"><div class="card-head"><div class="card-title">ğŸ¨ Colores del sitio</div><div style="display:flex;gap:.45rem;align-items:center;flex-wrap:wrap;"><button class="btn btn-ghost btn-sm" onclick="resetColores()">â†º Restaurar originales</button><button class="btn btn-primary btn-sm save-btn" onclick="saveColores()">ğŸ’¾ Guardar cambios</button></div></div>
          <div class="card-body">
            <div id="col-loading"><div class="skel" style="height:20px;width:50%;"></div><div class="skel"></div></div>
            <div id="col-form" style="display:none;">
              <div style="margin-bottom:1.6rem;">
                <div style="font-size:.68rem;font-weight:700;color:var(--text3);text-transform:uppercase;letter-spacing:.1em;margin-bottom:.65rem;">ğŸ‘ Vista previa en vivo</div>
                <div id="color-preview-bar" style="border-radius:12px;overflow:hidden;border:1.5px solid var(--border);">
                  <div id="cpv-header" style="padding:1.1rem 1.4rem;display:flex;align-items:center;gap:.85rem;background:linear-gradient(135deg,#FFE5F0,#E8D5FF);">
                    <div id="cpv-logo" style="width:40px;height:40px;border-radius:11px;display:flex;align-items:center;justify-content:center;font-size:1.1rem;background:linear-gradient(135deg,#FF85C0,#A67FFF);color:#fff;flex-shrink:0;">ğŸ’œ</div>
                    <div><div id="cpv-titulo" style="font-family:'Syne',sans-serif;font-weight:800;font-size:.95rem;color:#A67FFF;">Bienestar Emocional</div><div id="cpv-sub" style="font-size:.71rem;margin-top:.12rem;color:#5A5570;">Para NiÃ±os, adolescentes, adultos</div></div>
                  </div>
                  <div id="cpv-body" style="padding:.9rem 1.4rem;display:flex;gap:.65rem;flex-wrap:wrap;background:#FFE5F0;">
                    <div id="cpv-card1" style="border-radius:9px;padding:.55rem 1rem;font-size:.8rem;font-weight:700;background:linear-gradient(135deg,#FFE5F0,#E8D5FF);color:#A67FFF;">ğŸ¢ Empresas</div>
                    <div id="cpv-card2" style="border-radius:9px;padding:.55rem 1rem;font-size:.8rem;font-weight:700;background:linear-gradient(135deg,#FFE5F0,#E8D5FF);color:#A67FFF;">ğŸ« Escuelas</div>
                    <div id="cpv-btn" style="border-radius:50px;padding:.55rem 1.3rem;font-size:.8rem;font-weight:700;color:#fff;background:linear-gradient(135deg,#FF85C0,#A67FFF);">Ver mÃ¡s â†’</div>
                  </div>
                </div>
              </div>
              <div class="g2">
                <div class="fg"><label>Color principal â€” morado</label><div style="display:flex;gap:.55rem;align-items:center;"><input type="color" id="col-morado_intenso" value="#A67FFF" oninput="onColorChange()" style="width:44px;height:38px;"><input type="text" id="col-morado_intenso-hex" placeholder="#A67FFF" oninput="syncColorFromHex('morado_intenso')" style="flex:1;font-family:var(--mono);font-size:.85rem;"></div></div>
                <div class="fg"><label>Color acento â€” rosa</label><div style="display:flex;gap:.55rem;align-items:center;"><input type="color" id="col-rosa_intenso" value="#FF85C0" oninput="onColorChange()" style="width:44px;height:38px;"><input type="text" id="col-rosa_intenso-hex" placeholder="#FF85C0" oninput="syncColorFromHex('rosa_intenso')" style="flex:1;font-family:var(--mono);font-size:.85rem;"></div></div>
                <div class="fg"><label>Fondo suave â€” morado claro</label><div style="display:flex;gap:.55rem;align-items:center;"><input type="color" id="col-morado_claro" value="#E8D5FF" oninput="onColorChange()" style="width:44px;height:38px;"><input type="text" id="col-morado_claro-hex" placeholder="#E8D5FF" oninput="syncColorFromHex('morado_claro')" style="flex:1;font-family:var(--mono);font-size:.85rem;"></div></div>
                <div class="fg"><label>Fondo pastel â€” rosa claro</label><div style="display:flex;gap:.55rem;align-items:center;"><input type="color" id="col-rosa_claro" value="#FFE5F0" oninput="onColorChange()" style="width:44px;height:38px;"><input type="text" id="col-rosa_claro-hex" placeholder="#FFE5F0" oninput="syncColorFromHex('rosa_claro')" style="flex:1;font-family:var(--mono);font-size:.85rem;"></div></div>
                <div class="fg" style="grid-column:1/-1;"><label>Color de texto principal</label><div style="display:flex;gap:.55rem;align-items:center;"><input type="color" id="col-texto_oscuro" value="#2D2A3D" oninput="onColorChange()" style="width:44px;height:38px;"><input type="text" id="col-texto_oscuro-hex" placeholder="#2D2A3D" oninput="syncColorFromHex('texto_oscuro')" style="flex:1;font-family:var(--mono);font-size:.85rem;"></div></div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- â•â• VISIBILIDAD (EXPANDIDA) â•â• -->
      <div class="page" id="page-visibilidad">
        <div class="card">
          <div class="card-head">
            <div class="card-title">ğŸ‘ï¸ Visibilidad del sitio</div>
            <div style="display:flex;gap:.45rem;align-items:center;flex-wrap:wrap;">
              <button class="btn btn-ghost btn-sm" onclick="ocultarTodo()">ğŸ™ˆ Ocultar todo</button>
              <button class="btn btn-ghost btn-sm" onclick="mostrarTodo()">ğŸ‘ Mostrar todo</button>
              <button class="btn btn-primary btn-sm save-btn" onclick="saveVisibilidad()">ğŸ’¾ Guardar cambios</button>
            </div>
          </div>
          <div class="card-body">
            <div id="vis-loading"><div class="skel" style="height:20px;width:50%;"></div><div class="skel"></div><div class="skel" style="width:70%;"></div></div>
            <div id="vis-form" style="display:none;">

              <!-- Preview en vivo -->
              <div class="vis-preview-frame" id="vis-live-preview" style="margin-bottom:1.2rem;">
                <div class="vis-preview-frame-bar">
                  <div class="dot"></div>
                  <span>Vista previa del sitio (simulada)</span>
                  <span id="vis-preview-counter" style="margin-left:auto;color:var(--mi);font-weight:700;"></span>
                </div>
                <div id="vis-preview-content" style="padding:.9rem 1rem;display:flex;flex-wrap:wrap;gap:.4rem;min-height:52px;align-items:center;font-size:.78rem;"></div>
              </div>

              <!-- Secciones principales -->
              <div style="font-size:.68rem;font-weight:700;color:var(--text3);text-transform:uppercase;letter-spacing:.12em;margin-bottom:.65rem;margin-top:.2rem;">Secciones principales</div>
              <div style="display:flex;flex-direction:column;gap:.5rem;margin-bottom:1.2rem;" id="vis-toggles">

                <div class="vis-row" id="vis-row-header"><div class="vis-ico">ğŸ </div><div class="vis-info"><div class="vis-label">Header del sitio</div><div class="vis-desc">Logo, tÃ­tulo y subtÃ­tulos en la parte superior</div></div><label class="tog vis-tog"><input type="checkbox" id="vis-show_header" checked onchange="syncVisRow('show_header',this);updateVisPreview()"><span class="tog-sl"></span></label></div>

                <div class="vis-row" id="vis-row-hero"><div class="vis-ico">âœ¨</div><div class="vis-info"><div class="vis-label">SecciÃ³n Hero</div><div class="vis-desc">Frase motivacional principal del sitio</div></div><label class="tog vis-tog"><input type="checkbox" id="vis-show_hero" checked onchange="syncVisRow('show_hero',this);updateVisPreview()"><span class="tog-sl"></span></label></div>

                <div class="vis-row" id="vis-row-quienes"><div class="vis-ico">ğŸ‘¥</div><div class="vis-info"><div class="vis-label">Â¿QuiÃ©nes somos?</div><div class="vis-desc">Imagen y texto de presentaciÃ³n del consultorio</div></div><label class="tog vis-tog"><input type="checkbox" id="vis-show_quienes" checked onchange="syncVisRow('show_quienes',this);updateVisPreview()"><span class="tog-sl"></span></label></div>

                <div class="vis-row" id="vis-row-servicios"><div class="vis-ico">ğŸ—‚ï¸</div><div class="vis-info"><div class="vis-label">SecciÃ³n Servicios</div><div class="vis-desc">Tarjetas de todos los servicios</div></div><label class="tog vis-tog"><input type="checkbox" id="vis-show_servicios" checked onchange="syncVisRow('show_servicios',this);updateVisPreview();toggleSubServicios(this.checked)"><span class="tog-sl"></span></label></div>
              </div>

              <!-- Sub-servicios individuales -->
              <div id="vis-subservicios" style="margin-left:2rem;margin-bottom:1.2rem;">
                <div style="font-size:.68rem;font-weight:700;color:var(--text3);text-transform:uppercase;letter-spacing:.12em;margin-bottom:.55rem;">Tarjetas de servicios individuales</div>
                <div style="display:flex;flex-direction:column;gap:.45rem;">
                  <div class="vis-row" id="vis-row-srv-empresas"><div class="vis-ico">ğŸ¢</div><div class="vis-info"><div class="vis-label">Empresas</div><div class="vis-desc">Tarjeta del servicio para empresas</div></div><label class="tog vis-tog"><input type="checkbox" id="vis-show_srv_empresas" checked onchange="syncVisRow('show_srv_empresas',this);updateVisPreview()"><span class="tog-sl"></span></label></div>
                  <div class="vis-row" id="vis-row-srv-escuelas"><div class="vis-ico">ğŸ«</div><div class="vis-info"><div class="vis-label">Escuelas</div><div class="vis-desc">Tarjeta del servicio para escuelas</div></div><label class="tog vis-tog"><input type="checkbox" id="vis-show_srv_escuelas" checked onchange="syncVisRow('show_srv_escuelas',this);updateVisPreview()"><span class="tog-sl"></span></label></div>
                  <div class="vis-row" id="vis-row-srv-infantil"><div class="vis-ico">ğŸ‘¶</div><div class="vis-info"><div class="vis-label">NiÃ±os y Adolescentes</div><div class="vis-desc">Tarjeta del servicio infantil</div></div><label class="tog vis-tog"><input type="checkbox" id="vis-show_srv_infantil" checked onchange="syncVisRow('show_srv_infantil',this);updateVisPreview()"><span class="tog-sl"></span></label></div>
                  <div class="vis-row" id="vis-row-srv-adultos"><div class="vis-ico">ğŸ‘±</div><div class="vis-info"><div class="vis-label">Adultos</div><div class="vis-desc">Tarjeta del servicio para adultos</div></div><label class="tog vis-tog"><input type="checkbox" id="vis-show_srv_adultos" checked onchange="syncVisRow('show_srv_adultos',this);updateVisPreview()"><span class="tog-sl"></span></label></div>
                  <div class="vis-row" id="vis-row-srv-evaluaciones"><div class="vis-ico">ğŸ§ </div><div class="vis-info"><div class="vis-label">Evaluaciones</div><div class="vis-desc">Tarjeta del servicio de evaluaciones</div></div><label class="tog vis-tog"><input type="checkbox" id="vis-show_srv_evaluaciones" checked onchange="syncVisRow('show_srv_evaluaciones',this);updateVisPreview()"><span class="tog-sl"></span></label></div>
                </div>
              </div>

              <!-- Secciones de agenda y contacto -->
              <div style="font-size:.68rem;font-weight:700;color:var(--text3);text-transform:uppercase;letter-spacing:.12em;margin-bottom:.65rem;">Agenda y contacto</div>
              <div style="display:flex;flex-direction:column;gap:.5rem;margin-bottom:1.2rem;">
                <div class="vis-row" id="vis-row-disponibilidad"><div class="vis-ico">ğŸ“…</div><div class="vis-info"><div class="vis-label">BotÃ³n "Ver dÃ­as disponibles"</div><div class="vis-desc">Acceso directo al calendario de disponibilidad</div></div><label class="tog vis-tog"><input type="checkbox" id="vis-show_disponibilidad" checked onchange="syncVisRow('show_disponibilidad',this);updateVisPreview()"><span class="tog-sl"></span></label></div>
                <div class="vis-row" id="vis-row-mapa"><div class="vis-ico">ğŸ“</div><div class="vis-info"><div class="vis-label">Mapa de ubicaciÃ³n</div><div class="vis-desc">Iframe con Google Maps y botÃ³n "CÃ³mo llegar"</div></div><label class="tog vis-tog"><input type="checkbox" id="vis-show_mapa" checked onchange="syncVisRow('show_mapa',this);updateVisPreview()"><span class="tog-sl"></span></label></div>
                <div class="vis-row" id="vis-row-contacto"><div class="vis-ico">ğŸ“</div><div class="vis-info"><div class="vis-label">SecciÃ³n de contacto</div><div class="vis-desc">TelÃ©fono, correo y horario de atenciÃ³n</div></div><label class="tog vis-tog"><input type="checkbox" id="vis-show_contacto" checked onchange="syncVisRow('show_contacto',this);updateVisPreview()"><span class="tog-sl"></span></label></div>
                <div class="vis-row" id="vis-row-redes"><div class="vis-ico">ğŸ“±</div><div class="vis-info"><div class="vis-label">Redes sociales</div><div class="vis-desc">Botones de Facebook e Instagram</div></div><label class="tog vis-tog"><input type="checkbox" id="vis-show_redes" checked onchange="syncVisRow('show_redes',this);updateVisPreview()"><span class="tog-sl"></span></label></div>
                <div class="vis-row" id="vis-row-whatsapp-cta"><div class="vis-ico">ğŸ’¬</div><div class="vis-info"><div class="vis-label">BotÃ³n flotante de WhatsApp</div><div class="vis-desc">BotÃ³n de contacto rÃ¡pido vÃ­a WhatsApp</div></div><label class="tog vis-tog"><input type="checkbox" id="vis-show_whatsapp_cta" checked onchange="syncVisRow('show_whatsapp_cta',this);updateVisPreview()"><span class="tog-sl"></span></label></div>
              </div>

              <!-- Footer -->
              <div style="font-size:.68rem;font-weight:700;color:var(--text3);text-transform:uppercase;letter-spacing:.12em;margin-bottom:.65rem;">Pie de pÃ¡gina</div>
              <div style="display:flex;flex-direction:column;gap:.5rem;">
                <div class="vis-row" id="vis-row-footer"><div class="vis-ico">ğŸ“„</div><div class="vis-info"><div class="vis-label">Footer / Pie de pÃ¡gina</div><div class="vis-desc">Texto de copyright y links del footer</div></div><label class="tog vis-tog"><input type="checkbox" id="vis-show_footer" checked onchange="syncVisRow('show_footer',this);updateVisPreview()"><span class="tog-sl"></span></label></div>
                <div class="vis-row" id="vis-row-formularios"><div class="vis-ico">ğŸ“</div><div class="vis-info"><div class="vis-label">Formulario de contacto</div><div class="vis-desc">Formulario de solicitud de informaciÃ³n</div></div><label class="tog vis-tog"><input type="checkbox" id="vis-show_formularios" checked onchange="syncVisRow('show_formularios',this);updateVisPreview()"><span class="tog-sl"></span></label></div>
              </div>

            </div>
          </div>
        </div>
      </div>

      <!-- â•â• PENDIENTES â•â• -->
      <div class="page" id="page-pendientes">
        <div class="card">
          <div class="card-head">
            <div class="card-title">ğŸ“‹ Formularios pendientes</div>
            <button class="btn btn-ghost btn-sm" onclick="loadPendientes()">â†º Recargar</button>
          </div>
          <div class="card-body">
            <div class="info-box" style="margin-bottom:1.1rem;">Haz clic en cualquier tarjeta para abrir la <b>agenda</b> con los datos del solicitante prellenados. Al confirmar, el estado cambia a <b>En espera</b> y se envÃ­an notificaciones.</div>
            <div class="pend-filtros" id="pend-filtros">
              <button class="pend-filtro on" data-estado="todos" onclick="filtrarPend(this)">Todos <span class="n" id="pf-todos">0</span></button>
              <button class="pend-filtro" data-estado="Pendiente" onclick="filtrarPend(this)">â³ Pendiente <span class="n" id="pf-pendiente">0</span></button>
              <button class="pend-filtro" data-estado="En espera" onclick="filtrarPend(this)">ğŸ”µ En espera <span class="n" id="pf-espera">0</span></button>
              <button class="pend-filtro" data-estado="Confirmado" onclick="filtrarPend(this)">âœ… Confirmado <span class="n" id="pf-confirmado">0</span></button>
              <button class="pend-filtro" data-estado="Cancelado" onclick="filtrarPend(this)">âŒ Cancelado <span class="n" id="pf-cancelado">0</span></button>
            </div>
            <div id="pend-loading" style="display:none;">
              <div class="skel" style="height:95px;margin-bottom:.75rem;border-radius:14px;"></div>
              <div class="skel" style="height:95px;margin-bottom:.75rem;border-radius:14px;"></div>
              <div class="skel" style="height:95px;border-radius:14px;"></div>
            </div>
            <div id="pend-grid" class="pend-grid"></div>
          </div>
        </div>
      </div>

      <!-- â•â• USUARIOS â•â• -->
      <div class="page" id="page-usuarios">
        <div class="card"><div class="card-head"><div class="card-title">ğŸ‘¥ Usuarios del editor</div><button class="btn btn-primary btn-sm" onclick="openUserModal()">+ Nuevo usuario</button></div>
          <div class="card-body">
            <div class="info-box">Roles: <b>Administrador</b> (acceso total), <b>Editor</b> (editar contenido), <b>Visor</b> (solo lectura).</div>
            <div id="users-loading"><div class="skel"></div><div class="skel" style="width:80%;"></div></div>
            <div id="users-table" style="display:none;overflow-x:auto;"></div>
          </div>
        </div>
      </div>

    </div><!-- /main -->
  </div><!-- /shell -->
</div><!-- /app -->

<!-- â•â• MODAL USUARIO â•â• -->
<div class="overlay-modal" id="userModal">
  <div class="om-box">
    <button class="om-close" onclick="closeUserModal()">âœ•</button>
    <div class="om-title" id="um-title">ğŸ‘¤ Nuevo usuario</div>
    <input type="hidden" id="um-idx">
    <div class="fg"><label>Nombre completo</label><input type="text" id="um-nombre" placeholder="Ej. Ana Garcia"></div>
    <div class="fg"><label>Login (usuario)</label><input type="text" id="um-login" placeholder="Ej. ana.garcia" autocomplete="off"><div class="hint">Solo letras, numeros y punto. Sin espacios.</div></div>
    <div class="fg">
      <label>ContraseÃ±a <span id="um-pass-opt" style="font-weight:400;color:var(--text3);text-transform:none;font-size:.76rem;"></span></label>
      <div style="position:relative;"><input type="password" id="um-pass" placeholder="Minimo 8 caracteres" autocomplete="new-password" oninput="checkPassStrength()"><button type="button" onclick="togglePwd('um-pass',this)" style="position:absolute;right:.75rem;top:50%;transform:translateY(-50%);background:none;border:none;cursor:pointer;font-size:.9rem;color:var(--text3);">ğŸ‘</button></div>
      <div class="strength-bar" id="str-bar"></div><div class="hint" id="um-strength"></div>
    </div>
    <div class="fg"><label>Rol</label><select id="um-rol"><option value="admin">Administrador - acceso total</option><option value="editor" selected>Editor - editar contenido</option><option value="viewer">Visor - solo lectura</option></select></div>
    <div class="trow"><label class="tog"><input type="checkbox" id="um-activo" checked><span class="tog-sl"></span></label><span class="tog-lbl">Usuario activo</span></div>
    <button class="btn btn-primary" style="width:100%;justify-content:center;margin-top:.45rem;" onclick="saveUser()">ğŸ’¾ Guardar usuario</button>
  </div>
</div>

<!-- â•â• MODAL AGENDA â•â• -->
<div class="overlay-modal" id="agendaModal">
  <div class="om-box" style="width:620px;max-width:96vw;">
    <button class="om-close" onclick="cerrarAgenda()">âœ•</button>
    <div class="om-title">ğŸ“… Asignar fecha de cita</div>
    <div class="agenda-context">
      <div class="agenda-context-nombre" id="ag-nombre">â€”</div>
      <div class="agenda-context-info">
        <span>ğŸ“± <span id="ag-tel">â€”</span></span>
        <span>ğŸ“§ <span id="ag-correo">â€”</span></span>
        <span>ğŸ·ï¸ <span id="ag-servicio">â€”</span></span>
      </div>
      <div style="margin-top:.45rem;font-size:.76rem;color:var(--text2);" id="ag-motivo-wrap">ğŸ“ <span id="ag-motivo"></span></div>
    </div>
    <div style="font-size:.68rem;font-weight:700;color:var(--text3);text-transform:uppercase;letter-spacing:.1em;margin-bottom:.55rem;">Selecciona un horario disponible</div>
    <div id="ag-slots-container"><div class="slot-loading"><div class="slot-spinner"></div>Cargando disponibilidad...</div></div>
    <div class="notif-section" style="margin-top:1rem;">
      <div class="notif-title">ğŸ“¤ Notificaciones a enviar</div>
      <div class="notif-checks">
        <label class="notif-check"><input type="checkbox" id="notif-wa" checked><div class="notif-check-txt">WhatsApp al solicitante<small>Abre wa.me con el mensaje prellenado</small></div></label>
        <label class="notif-check"><input type="checkbox" id="notif-email" checked><div class="notif-check-txt">Correo electrÃ³nico al solicitante<small>Via el proxy de Google Apps Script</small></div></label>
        <label class="notif-check"><input type="checkbox" id="notif-admin" checked><div class="notif-check-txt">NotificaciÃ³n al administrador<small>WhatsApp con resumen de la cita confirmada</small></div></label>
      </div>
      <textarea class="notif-msg" id="notif-msg-extra" placeholder="Mensaje adicional para el solicitante (opcional)..."></textarea>
    </div>
    <div style="display:flex;gap:.65rem;margin-top:1.1rem;">
      <button class="btn btn-ghost" style="flex:1;justify-content:center;" onclick="cerrarAgenda()">Cancelar</button>
      <button class="btn btn-primary" style="flex:2;justify-content:center;" id="ag-confirmar-btn" onclick="confirmarCita()" disabled>ğŸ“¨ Confirmar y notificar</button>
    </div>
  </div>
</div>

<div class="toasts" id="toasts"></div>

<button onclick="window.open('responder-formularios.html','_blank')" style="position:fixed;bottom:1.4rem;left:9rem;z-index:8999;background:var(--surface2);color:var(--text2);border:1px solid var(--border2);border-radius:50px;padding:.68rem 1.2rem;font-family:'Manrope',sans-serif;font-size:.82rem;font-weight:600;cursor:pointer;transition:all .2s;" onmouseover="this.style.borderColor='var(--mi)';this.style.color='var(--mi)'" onmouseout="this.style.borderColor='var(--border2)';this.style.color='var(--text2)'">ğŸ“‹ Formularios</button>
<button class="agenda-float" onclick="window.open('agenda.html','_blank')">ğŸ“… Agenda</button>

<script>
'use strict';
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CONFIGURACION
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
var PROXY='https://script.google.com/macros/s/AKfycbz-_1X-c3aZ2lJ4N6m3R5tP2l2cznIs7Seuvkb5X5J1oPVrIXDwkEHi936b4dXg5JxO/exec';
var WA_ADMIN='524425839311';
var MAX_ATT=5,INACT_MS=20*60*1000;
var MODAL_TABS=['Empresas','Escuelas','Infantil','Adultos','Evaluaciones'];
var MODAL_EMOJI={Empresas:'ğŸ¢',Escuelas:'ğŸ«',Infantil:'ğŸ‘¶',Adultos:'ğŸ‘±',Evaluaciones:'ğŸ§ '};
var attempts=MAX_ATT,currentUser=null,inactTimer=null,currentTab='config',usersData=[],saving=false;
var COLORES_DEFAULT={morado_intenso:'#A67FFF',rosa_intenso:'#FF85C0',morado_claro:'#E8D5FF',rosa_claro:'#FFE5F0',texto_oscuro:'#2D2A3D'};

// Visibilidad â€” todas las secciones incluyendo nuevas
var VIS_SECCIONES=['show_header','show_hero','show_quienes','show_servicios','show_srv_empresas','show_srv_escuelas','show_srv_infantil','show_srv_adultos','show_srv_evaluaciones','show_disponibilidad','show_mapa','show_contacto','show_redes','show_whatsapp_cta','show_footer','show_formularios'];
var VIS_LABELS={show_header:'Header',show_hero:'Hero',show_quienes:'QuiÃ©nes somos',show_servicios:'Servicios',show_srv_empresas:'Empresas',show_srv_escuelas:'Escuelas',show_srv_infantil:'Infantil',show_srv_adultos:'Adultos',show_srv_evaluaciones:'Evaluaciones',show_disponibilidad:'Disponibilidad',show_mapa:'Mapa',show_contacto:'Contacto',show_redes:'Redes',show_whatsapp_cta:'WhatsApp CTA',show_footer:'Footer',show_formularios:'Formularios'};

var DIAS=['Domingo','Lunes','Martes','MiÃ©rcoles','Jueves','Viernes','SÃ¡bado'];
var MESES=['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];
var pendientesData=[],filtroActivo='todos',pendienteActivo=null,slotActivo=null,slotsCache=null;

/* â•â•â• API â•â•â• */
function apiGet(tab){return fetch(PROXY+'?tab='+encodeURIComponent(tab),{redirect:'follow'}).then(function(r){return r.text();}).then(function(t){var j=JSON.parse(t);if(!j.ok)throw new Error(j.error||'Error');return j.data;});}
function apiPost(tab,data){return fetch(PROXY,{method:'POST',redirect:'follow',headers:{'Content-Type':'text/plain'},body:JSON.stringify({tab:tab,data:data})}).then(function(r){return r.text();}).then(function(t){var j=JSON.parse(t);if(!j.ok)throw new Error(j.error||'Error al guardar');return j;});}
function apiAction(action,payload){return fetch(PROXY,{method:'POST',redirect:'follow',headers:{'Content-Type':'text/plain'},body:JSON.stringify(Object.assign({action:action},payload))}).then(function(r){return r.text();}).then(function(t){var j=JSON.parse(t);if(!j.ok)throw new Error(j.error||'Error');return j;});}

/* â•â•â• SUBIDA DE IMAGENES â•â•â• */
var UPLOADERS={
  'logo'   :{hidden:'cfg-logo_url',      uploader:'up-logo',    preview:'prev-logo',    file:'file-logo',    savedBar:'saved-logo',   savedLink:'saved-logo-link'},
  'quienes':{hidden:'cfg-quienes_imagen',uploader:'up-quienes', preview:'prev-quienes', file:'file-quienes', savedBar:'saved-quienes',savedLink:'saved-quienes-link'},
  'modal'  :{hidden:'m-imagen',          uploader:'up-modal',   preview:'prev-modal',   file:'file-modal',   savedBar:'saved-modal',  savedLink:'saved-modal-link'}
};
function extractFileId(url){if(!url)return null;var m;m=url.match(/googleusercontent\.com\/d\/([a-zA-Z0-9_-]+)/);if(m)return m[1];m=url.match(/[?&]id=([a-zA-Z0-9_-]+)/);if(m)return m[1];m=url.match(/\/d\/([a-zA-Z0-9_-]+)\//);if(m)return m[1];m=url.match(/thumbnail\?id=([a-zA-Z0-9_-]+)/);if(m)return m[1];return null;}
function setImgWithFallback(imgEl,fileId,blobSrc){if(!imgEl)return;var fallbacks=blobSrc?[blobSrc]:[];if(fileId){if(!blobSrc)fallbacks.push('https://lh3.googleusercontent.com/d/'+fileId);fallbacks.push('https://drive.google.com/thumbnail?id='+fileId+'&sz=w800');fallbacks.push('https://drive.google.com/uc?export=view&id='+fileId);}var tried=0;imgEl.onerror=function(){tried++;if(tried<fallbacks.length){imgEl.src=fallbacks[tried];}else{imgEl.onerror=null;imgEl.style.display='none';if(!imgEl.parentNode.querySelector('.img-blocked-ph')){var ph=document.createElement('div');ph.className='img-blocked-ph';ph.innerHTML='ğŸ–¼ Imagen guardada en Drive<br><small>Vista previa no disponible.</small>';imgEl.parentNode.insertBefore(ph,imgEl.nextSibling);}}};imgEl.style.display='';imgEl.src=fallbacks[0]||'';}
document.addEventListener('DOMContentLoaded',function(){Object.keys(UPLOADERS).forEach(function(key){var cfg=UPLOADERS[key];var fi=document.getElementById(cfg.file);if(fi)fi.addEventListener('change',function(){handleFileSelect(this,key);});var up=document.getElementById(cfg.uploader);if(up){up.addEventListener('dragover',function(e){e.preventDefault();up.classList.add('drag-over');});up.addEventListener('dragleave',function(){up.classList.remove('drag-over');});up.addEventListener('drop',function(e){e.preventDefault();up.classList.remove('drag-over');var f=e.dataTransfer.files[0];if(f)processFile(f,key);});}});});
function handleFileSelect(input,key){var file=input.files&&input.files[0];if(!file)return;processFile(file,key);input.value='';}
function processFile(file,key){var allowed=['image/jpeg','image/png','image/webp','image/gif'];if(allowed.indexOf(file.type)===-1){toast('Tipo no permitido. Usa JPG, PNG o WEBP.','err');return;}if(file.size>5*1024*1024){toast('La imagen supera 5 MB.','err');return;}var blobUrl=URL.createObjectURL(file);_showPreviewBlob(key,blobUrl);setProgress(key,15);setStatus(key,'uploading','');apiUpload(file).then(function(res){var fileId=res.fileId||'';var storedUrl='https://lh3.googleusercontent.com/d/'+fileId;document.getElementById(UPLOADERS[key].hidden).value=storedUrl;var prevWrap=document.getElementById(UPLOADERS[key].preview);var imgEl=prevWrap?prevWrap.querySelector('img'):null;if(imgEl){URL.revokeObjectURL(blobUrl);setImgWithFallback(imgEl,fileId,null);}var driveLink=res.driveUrl||('https://drive.google.com/file/d/'+fileId+'/view');showSavedBar(key,driveLink);setProgress(key,100);setStatus(key,'ok','Imagen subida a Drive');if(key==='modal')updatePreview();toast('Imagen subida correctamente','ok');setTimeout(function(){setProgress(key,0);},2500);}).catch(function(err){setStatus(key,'err','Error: '+err.message);setProgress(key,0);toast('Error al subir: '+err.message,'err');clearImg(key);});}
function apiUpload(file){return new Promise(function(resolve,reject){var reader=new FileReader();reader.onload=function(e){var parts=e.target.result.split(',');fetch(PROXY,{method:'POST',redirect:'follow',headers:{'Content-Type':'text/plain'},body:JSON.stringify({action:'upload',filename:file.name.replace(/[^a-zA-Z0-9._-]/g,'_'),mimeType:file.type||'image/jpeg',base64:parts[1]})}).then(function(r){return r.text();}).then(function(t){var j=JSON.parse(t);if(!j.ok)reject(new Error(j.error||'Error al subir'));else resolve(j);}).catch(reject);};reader.onerror=function(){reject(new Error('No se pudo leer el archivo'));};reader.readAsDataURL(file);});}
function _showPreviewBlob(key,blobUrl){var cfg=UPLOADERS[key];var prevWrap=document.getElementById(cfg.preview);var imgEl=prevWrap.querySelector('img');imgEl.onerror=null;imgEl.style.display='';imgEl.src=blobUrl;prevWrap.classList.add('show');var lbl=document.querySelector('#'+cfg.uploader+' .img-drop-label');if(lbl)lbl.style.display='none';var ph=prevWrap.querySelector('.img-blocked-ph');if(ph)ph.remove();}
function clearImg(key){var cfg=UPLOADERS[key];document.getElementById(cfg.hidden).value='';var prevWrap=document.getElementById(cfg.preview);prevWrap.classList.remove('show');var imgEl=prevWrap.querySelector('img');if(imgEl){imgEl.src='';imgEl.onerror=null;imgEl.style.display='';}var ph=prevWrap.querySelector('.img-blocked-ph');if(ph)ph.remove();var lbl=document.querySelector('#'+cfg.uploader+' .img-drop-label');if(lbl)lbl.style.display='';hideSavedBar(key);setStatus(key,'none','');setProgress(key,0);if(key==='modal')updatePreview();}
function preloadImg(key,url){if(!url)return;var cfg=UPLOADERS[key];if(!cfg)return;document.getElementById(cfg.hidden).value=url;var fileId=extractFileId(url);var prevWrap=document.getElementById(cfg.preview);var imgEl=prevWrap?prevWrap.querySelector('img'):null;prevWrap.classList.add('show');var lbl=document.querySelector('#'+cfg.uploader+' .img-drop-label');if(lbl)lbl.style.display='none';var ph=prevWrap?prevWrap.querySelector('.img-blocked-ph'):null;if(ph)ph.remove();setImgWithFallback(imgEl,fileId,fileId?null:url);var driveLink=fileId?('https://drive.google.com/file/d/'+fileId+'/view'):url;showSavedBar(key,driveLink);setStatus(key,'ok','Imagen cargada desde Drive');}
function showSavedBar(key,driveUrl){var cfg=UPLOADERS[key];var bar=document.getElementById(cfg.savedBar);var link=document.getElementById(cfg.savedLink);if(bar&&link){link.href=driveUrl||'#';bar.classList.add('show');}}
function hideSavedBar(key){var cfg=UPLOADERS[key];var bar=document.getElementById(cfg.savedBar);if(bar)bar.classList.remove('show');}
function setProgress(key,pct){var bar=document.getElementById('prog-'+key);if(bar)bar.style.width=pct+'%';}
function setStatus(key,type,msg){var el=document.getElementById('stat-'+key);if(!el)return;el.classList.remove('show');if(type==='uploading'){el.innerHTML='<span class="spin" style="width:13px;height:13px;border-width:2px;"></span> Subiendo a Drive...';el.style.color='var(--mi)';el.classList.add('show');}else if(type==='ok'){el.textContent=msg;el.style.color='var(--ok)';el.classList.add('show');}else if(type==='err'){el.textContent=msg;el.style.color='var(--err)';el.classList.add('show');}}

/* â•â•â• AUTH â•â•â• */
function doLogin(){var lu=document.getElementById('lu').value.trim(),lp=document.getElementById('lp').value,btn=document.getElementById('lbtn');if(!lu||!lp){showLErr('Completa usuario y contraseÃ±a.');return;}var lock=parseInt(sessionStorage.getItem('be_lock')||'0');if(Date.now()<lock){showLErr('Bloqueado '+Math.ceil((lock-Date.now())/60000)+' min mas.');return;}btn.disabled=true;btn.innerHTML='<span class="spin"></span> Verificando...';apiGet('Usuarios').then(function(data){var users=parseUsers(data),user=users.find(function(u){return u.login===lu&&u.pass===lp&&u.activo==='true';});if(user){attempts=MAX_ATT;sessionStorage.removeItem('be_lock');currentUser=user;sessionStorage.setItem('be_sess',JSON.stringify({login:user.login,nombre:user.nombre,rol:user.rol,ts:Date.now()}));launchApp(user);}else{attempts--;document.getElementById('latt').textContent=attempts;['lu','lp'].forEach(function(id){var el=document.getElementById(id);el.classList.add('bad');setTimeout(function(){el.classList.remove('bad');},700);});if(attempts<=0){sessionStorage.setItem('be_lock',Date.now()+5*60*1000);attempts=MAX_ATT;showLErr('Demasiados intentos. Bloqueado 5 minutos.');}else showLErr('Usuario o contraseÃ±a incorrectos.');btn.disabled=false;btn.innerHTML='Entrar al editor';}}).catch(function(err){showLErr('Error de conexion: '+err.message);btn.disabled=false;btn.innerHTML='Entrar al editor';});}
function parseUsers(data){var users=[],i=1;while(data['login_'+i]!==undefined){if(data['login_'+i])users.push({idx:i,login:data['login_'+i]||'',pass:data['pass_'+i]||'',nombre:data['nombre_'+i]||'',rol:data['rol_'+i]||'editor',activo:data['activo_'+i]||'false'});i++;}return users;}
function showLErr(m){var e=document.getElementById('lerr');e.textContent=m;e.classList.remove('show');void e.offsetWidth;e.classList.add('show');}
function launchApp(user){document.getElementById('loginScreen').classList.add('hidden');document.getElementById('app').classList.add('on');document.getElementById('uav').textContent=user.nombre.charAt(0).toUpperCase();document.getElementById('uname').textContent=user.nombre;document.getElementById('urole').textContent=({admin:'Administrador',editor:'Editor',viewer:'Visor'})[user.rol]||user.rol;applyRoleUI(user.rol);goTo('config',document.getElementById('nav-config'));resetInact();document.addEventListener('mousemove',resetInact);document.addEventListener('keydown',resetInact);contarPendientes();}
function applyRoleUI(rol){var uNav=document.getElementById('nav-usuarios');if(uNav)uNav.style.display=(rol==='admin')?'':'none';if(rol==='viewer')document.querySelectorAll('.save-btn').forEach(function(b){b.style.display='none';});}
function doLogout(){if(!confirm('Â¿Cerrar sesion?'))return;clearTimeout(inactTimer);currentUser=null;sessionStorage.removeItem('be_sess');document.removeEventListener('mousemove',resetInact);document.removeEventListener('keydown',resetInact);document.getElementById('loginScreen').classList.remove('hidden');document.getElementById('app').classList.remove('on');var btn=document.getElementById('lbtn');btn.disabled=false;btn.innerHTML='Entrar al editor';document.getElementById('lerr').classList.remove('show');document.getElementById('lu').value='';document.getElementById('lp').value='';document.getElementById('latt').textContent=MAX_ATT;attempts=MAX_ATT;}
function resetInact(){clearTimeout(inactTimer);inactTimer=setTimeout(function(){toast('Sesion cerrada por inactividad','warn');doLogout();},INACT_MS);}
function togglePwd(id,btn){var inp=document.getElementById(id);inp.type=inp.type==='password'?'text':'password';btn.textContent=inp.type==='password'?'ver':'ocultar';}
(function(){try{var s=JSON.parse(sessionStorage.getItem('be_sess'));if(s&&(Date.now()-s.ts)<INACT_MS){currentUser={login:s.login,nombre:s.nombre,rol:s.rol};launchApp(currentUser);}}catch(e){}})();

/* â•â•â• NAVEGACION â•â•â• */
function goTo(name,el){
  document.querySelectorAll('.page').forEach(function(p){p.classList.remove('on');});
  document.querySelectorAll('.nav-item').forEach(function(n){n.classList.remove('on');});
  if(el)el.classList.add('on');
  if(MODAL_TABS.indexOf(name)!==-1){currentTab=name;document.getElementById('page-modal').classList.add('on');document.getElementById('modal-card-title').textContent=(MODAL_EMOJI[name]||'')+' '+name;loadCurrentModal();}
  else if(name==='colores'){document.getElementById('page-colores').classList.add('on');loadColoresPage();}
  else if(name==='visibilidad'){document.getElementById('page-visibilidad').classList.add('on');loadVisibilidadPage();}
  else if(name==='pendientes'){document.getElementById('page-pendientes').classList.add('on');loadPendientes();}
  else{document.getElementById('page-'+name).classList.add('on');loadPage(name);}
}
function loadPage(name){
  if(name==='config')  loadTab('Config',  fillConfig,  'cfg');
  if(name==='contacto')loadTab('Contacto',fillContacto,'ctc');
  if(name==='mapa')    loadTab('Mapa',    fillMapa,    'map');
  if(name==='usuarios')loadUsersPage();
}

/* â•â•â• LOADERS â•â•â• */
function loadTab(tab,fillFn,prefix){var sk=document.getElementById(prefix+'-loading'),fm=document.getElementById(prefix+'-form');if(sk)sk.style.display='block';if(fm)fm.style.display='none';apiGet(tab).then(function(data){fillFn(data);if(sk)sk.style.display='none';if(fm)fm.style.display='block';}).catch(function(e){toast('Error al cargar '+tab+': '+e.message,'err');if(sk)sk.style.display='none';if(fm)fm.style.display='block';});}
function saveTab(tab){if(saving)return;if(currentUser&&currentUser.rol==='viewer'){toast('Los visores no pueden guardar.','warn');return;}var data=collectTab(tab);if(!data)return;saving=true;apiPost(tab,data).then(function(){toast(tab+' guardado','ok');}).catch(function(e){toast('Error: '+e.message,'err');}).finally(function(){saving=false;});}
function collectTab(tab){if(tab==='Config')return collectConfig();if(tab==='Contacto')return collectContacto();if(tab==='Mapa')return collectMapa();return null;}
function fillConfig(d){sv('cfg-titulo',d.titulo);sv('cfg-subtitulo1',d.subtitulo1);sv('cfg-subtitulo2',d.subtitulo2);sv('cfg-hero_titulo',d.hero_titulo);sv('cfg-hero_descripcion',d.hero_descripcion);sv('cfg-quienes_titulo',d.quienes_titulo);sv('cfg-quienes_texto',d.quienes_texto);sv('cfg-footer_texto',d.footer_texto);clearImg('logo');clearImg('quienes');preloadImg('logo',d.logo_url);preloadImg('quienes',d.quienes_imagen);}
function collectConfig(){return{titulo:gv('cfg-titulo'),subtitulo1:gv('cfg-subtitulo1'),subtitulo2:gv('cfg-subtitulo2'),logo_url:gv('cfg-logo_url'),hero_titulo:gv('cfg-hero_titulo'),hero_descripcion:gv('cfg-hero_descripcion'),quienes_titulo:gv('cfg-quienes_titulo'),quienes_texto:gv('cfg-quienes_texto'),quienes_imagen:gv('cfg-quienes_imagen'),footer_texto:gv('cfg-footer_texto')};}
function fillContacto(d){sv('ctc-telefono',d.telefono);sv('ctc-correo',d.correo);sv('ctc-horario',d.horario);sv('ctc-facebook',d.facebook);sv('ctc-instagram',d.instagram);sv('ctc-whatsapp_mensaje',d.whatsapp_mensaje);}
function collectContacto(){return{telefono:gv('ctc-telefono'),correo:gv('ctc-correo'),horario:gv('ctc-horario'),facebook:gv('ctc-facebook'),instagram:gv('ctc-instagram'),whatsapp_mensaje:gv('ctc-whatsapp_mensaje')};}
function fillMapa(d){sv('map-latitud',d.latitud);sv('map-longitud',d.longitud);sv('map-embed_url',d.embed_url||'');sv('map-boton_texto',d.boton_texto);sv('map-link_directo',d.link_directo||'');if(d.latitud&&d.longitud){buildEmbedFromCoords();}else if(d.embed_url){previewMapEmbed();}}
function collectMapa(){return{latitud:gv('map-latitud'),longitud:gv('map-longitud'),embed_url:gv('map-embed_url'),boton_texto:gv('map-boton_texto'),link_directo:gv('map-link_directo')};}
function buildEmbedFromCoords(){var lat=gv('map-latitud'),lng=gv('map-longitud'),p=document.getElementById('map-coords-preview'),ifr=document.getElementById('map-iframe');var lN=parseFloat(lat),lnN=parseFloat(lng);if(isNaN(lN)||isNaN(lnN)||!lat||!lng){if(p)p.style.display='none';return;}var src='https://maps.google.com/maps?q='+lN+','+lnN+'&z=17&output=embed';if(ifr)ifr.src=src;if(p)p.style.display='block';sv('map-embed_url',src);}
function previewMapEmbed(){var src=gv('map-embed_url'),p=document.getElementById('map-coords-preview'),ifr=document.getElementById('map-iframe');if(!src){if(p)p.style.display='none';return;}if(ifr)ifr.src=src;if(p)p.style.display='block';}

/* â•â•â• COLORES â•â•â• */
function loadColoresPage(){var sk=document.getElementById('col-loading'),fm=document.getElementById('col-form');if(sk)sk.style.display='block';if(fm)fm.style.display='none';apiGet('Config').then(function(d){Object.keys(COLORES_DEFAULT).forEach(function(k){var val=d['color_'+k]||COLORES_DEFAULT[k];var cp=document.getElementById('col-'+k),hx=document.getElementById('col-'+k+'-hex');if(cp)cp.value=val;if(hx)hx.value=val;});onColorChange();if(sk)sk.style.display='none';if(fm)fm.style.display='block';}).catch(function(){Object.keys(COLORES_DEFAULT).forEach(function(k){var cp=document.getElementById('col-'+k),hx=document.getElementById('col-'+k+'-hex');if(cp)cp.value=COLORES_DEFAULT[k];if(hx)hx.value=COLORES_DEFAULT[k];});onColorChange();if(sk)sk.style.display='none';if(fm)fm.style.display='block';});}
function syncColorFromHex(key){var hx=document.getElementById('col-'+key+'-hex'),cp=document.getElementById('col-'+key);if(!hx||!cp)return;var val=hx.value.trim();if(/^#[0-9A-Fa-f]{6}$/.test(val)){cp.value=val;onColorChange();}}
function onColorChange(){var mi=(document.getElementById('col-morado_intenso')||{value:COLORES_DEFAULT.morado_intenso}).value,ri=(document.getElementById('col-rosa_intenso')||{value:COLORES_DEFAULT.rosa_intenso}).value,mc=(document.getElementById('col-morado_claro')||{value:COLORES_DEFAULT.morado_claro}).value,rc=(document.getElementById('col-rosa_claro')||{value:COLORES_DEFAULT.rosa_claro}).value,tx=(document.getElementById('col-texto_oscuro')||{value:COLORES_DEFAULT.texto_oscuro}).value;['morado_intenso','rosa_intenso','morado_claro','rosa_claro','texto_oscuro'].forEach(function(k){var cp=document.getElementById('col-'+k),hx=document.getElementById('col-'+k+'-hex');if(cp&&hx)hx.value=cp.value;});var hdr=document.getElementById('cpv-header');if(hdr)hdr.style.background='linear-gradient(135deg,'+rc+','+mc+')';var logo=document.getElementById('cpv-logo');if(logo)logo.style.background='linear-gradient(135deg,'+ri+','+mi+')';var tit=document.getElementById('cpv-titulo');if(tit)tit.style.color=mi;var sub=document.getElementById('cpv-sub');if(sub)sub.style.color=tx;var body=document.getElementById('cpv-body');if(body)body.style.background=rc;var c1=document.getElementById('cpv-card1');if(c1){c1.style.background='linear-gradient(135deg,'+rc+','+mc+')';c1.style.color=mi;}var c2=document.getElementById('cpv-card2');if(c2){c2.style.background='linear-gradient(135deg,'+rc+','+mc+')';c2.style.color=mi;}var btn=document.getElementById('cpv-btn');if(btn)btn.style.background='linear-gradient(135deg,'+ri+','+mi+')';}
function resetColores(){if(!confirm('Â¿Restaurar colores originales?'))return;Object.keys(COLORES_DEFAULT).forEach(function(k){var cp=document.getElementById('col-'+k),hx=document.getElementById('col-'+k+'-hex');if(cp)cp.value=COLORES_DEFAULT[k];if(hx)hx.value=COLORES_DEFAULT[k];});onColorChange();toast('Colores restaurados â€” guarda para aplicar','warn');}
function saveColores(){if(saving)return;var data={};Object.keys(COLORES_DEFAULT).forEach(function(k){var cp=document.getElementById('col-'+k);if(cp)data['color_'+k]=cp.value;});saving=true;apiPost('Config',data).then(function(){toast('Colores guardados','ok');}).catch(function(e){toast('Error: '+e.message,'err');}).finally(function(){saving=false;});}

/* â•â•â• VISIBILIDAD EXPANDIDA â•â•â• */
function loadVisibilidadPage(){
  var sk=document.getElementById('vis-loading'),fm=document.getElementById('vis-form');
  if(sk)sk.style.display='block';if(fm)fm.style.display='none';
  apiGet('Config').then(function(d){
    VIS_SECCIONES.forEach(function(k){
      var chk=document.getElementById('vis-'+k);
      if(chk){chk.checked=(d[k]!=='false');syncVisRow(k,chk);}
    });
    if(sk)sk.style.display='none';if(fm)fm.style.display='block';
    updateVisPreview();
    toggleSubServicios(document.getElementById('vis-show_servicios').checked);
  }).catch(function(){
    VIS_SECCIONES.forEach(function(k){var chk=document.getElementById('vis-'+k);if(chk)chk.checked=true;});
    if(sk)sk.style.display='none';if(fm)fm.style.display='block';
    updateVisPreview();
  });
}

function syncVisRow(key,chk){
  var shortKey=key.replace('show_','').replace(/_/g,'-'),row=document.getElementById('vis-row-'+shortKey);
  if(!row){
    // Intentar tambiÃ©n con underscore para IDs compuestos
    var altKey=key.replace('show_','');
    row=document.getElementById('vis-row-'+altKey);
  }
  if(!row)return;
  var v=chk.checked;
  if(v){row.classList.remove('vis-off');}
  else{row.classList.add('vis-off');}
}

function toggleSubServicios(visible){
  var sub=document.getElementById('vis-subservicios');
  if(sub)sub.style.opacity=visible?'1':'0.4';
  var subs=['show_srv_empresas','show_srv_escuelas','show_srv_infantil','show_srv_adultos','show_srv_evaluaciones'];
  subs.forEach(function(k){
    var chk=document.getElementById('vis-'+k);
    if(chk)chk.disabled=!visible;
  });
}

function updateVisPreview(){
  var content=document.getElementById('vis-preview-content');
  if(!content)return;
  var items=[];
  var previewMap={
    show_header:'ğŸ  Header',show_hero:'âœ¨ Hero',show_quienes:'ğŸ‘¥ QuiÃ©nes somos',
    show_servicios:'ğŸ—‚ï¸ Servicios',show_srv_empresas:'ğŸ¢',show_srv_escuelas:'ğŸ«',
    show_srv_infantil:'ğŸ‘¶',show_srv_adultos:'ğŸ‘±',show_srv_evaluaciones:'ğŸ§ ',
    show_disponibilidad:'ğŸ“… Disponibilidad',show_mapa:'ğŸ“ Mapa',
    show_contacto:'ğŸ“ Contacto',show_redes:'ğŸ“± Redes',
    show_whatsapp_cta:'ğŸ’¬ WA',show_footer:'ğŸ“„ Footer',show_formularios:'ğŸ“ Form'
  };
  var total=0,visible=0;
  VIS_SECCIONES.forEach(function(k){
    total++;
    var chk=document.getElementById('vis-'+k);
    var isOn=chk?chk.checked:true;
    if(isOn)visible++;
    var label=previewMap[k]||k;
    items.push('<span style="display:inline-flex;align-items:center;gap:.2rem;padding:.2rem .55rem;border-radius:50px;font-size:.7rem;font-weight:600;border:1px solid '+(isOn?'var(--ok-border)':'var(--err-border)')+';background:'+(isOn?'var(--ok-bg)':'var(--err-bg)')+';color:'+(isOn?'var(--ok)':'var(--err)')+';">'+label+'</span>');
  });
  content.innerHTML=items.join('');
  var counter=document.getElementById('vis-preview-counter');
  if(counter)counter.textContent=visible+'/'+total+' visibles';
}

function mostrarTodo(){VIS_SECCIONES.forEach(function(k){var chk=document.getElementById('vis-'+k);if(chk){chk.checked=true;syncVisRow(k,chk);}});updateVisPreview();toast('Todas las secciones visibles','ok');}
function ocultarTodo(){VIS_SECCIONES.forEach(function(k){var chk=document.getElementById('vis-'+k);if(chk){chk.checked=false;syncVisRow(k,chk);}});updateVisPreview();toast('Todas las secciones ocultas','warn');}
function saveVisibilidad(){
  if(saving)return;
  var data={};
  VIS_SECCIONES.forEach(function(k){var chk=document.getElementById('vis-'+k);if(chk)data[k]=chk.checked?'true':'false';});
  saving=true;
  apiPost('Config',data).then(function(){toast('Visibilidad guardada','ok');}).catch(function(e){toast('Error: '+e.message,'err');}).finally(function(){saving=false;});
}

/* â•â•â• MODAL SERVICIOS â•â•â• */
function loadCurrentModal(){document.getElementById('modal-loading').style.display='block';document.getElementById('modal-form').style.display='none';setModalStatus('Cargando...','warn');apiGet(currentTab).then(function(data){fillModalForm(data);document.getElementById('modal-loading').style.display='none';document.getElementById('modal-form').style.display='block';setModalStatus('Cargado','ok');updatePreview();}).catch(function(e){document.getElementById('modal-loading').style.display='none';setModalStatus('Error','err');toast('Error al cargar '+currentTab+': '+e.message,'err');});}
function setModalStatus(text,type){var el=document.getElementById('modal-status');el.textContent=text;el.className='badge badge-'+type;}
function fillModalForm(d){sv('m-titulo',d.titulo);sv('m-intro',d.intro);sv('m-badge',d.badge);sv('m-servicios_titulo',d.servicios_titulo);sv('m-temas_titulo',d.temas_titulo);sv('m-cta_texto',d.cta_texto);sv('m-cta_url',d.cta_url);sv('m-modalidad',d.modalidad);clearImg('modal');preloadImg('modal',d.imagen);var svcs=[],i=1;while(d['servicio_'+i]!==undefined){if(d['servicio_'+i])svcs.push(d['servicio_'+i]);i++;}renderDynList('m-svc-list',svcs,'svc');var temas=[];i=1;while(d['tema_'+i]!==undefined){if(d['tema_'+i])temas.push(d['tema_'+i]);i++;}renderDynList('m-tema-list',temas,'tema');}
function renderDynList(cid,items,type){var c=document.getElementById(cid);c.innerHTML='';items.forEach(function(v){c.appendChild(makeDynRow(v,type));});}
function makeDynRow(val,type){var row=document.createElement('div');row.className='dyn-row';var inp=document.createElement('input');inp.type='text';inp.value=val||'';inp.addEventListener('input',updatePreview);var rm=document.createElement('button');rm.className='dyn-rm';rm.type='button';rm.textContent='Ã—';rm.addEventListener('click',function(){row.remove();updatePreview();});row.appendChild(inp);row.appendChild(rm);return row;}
function addDynItem(type){document.getElementById(type==='svc'?'m-svc-list':'m-tema-list').appendChild(makeDynRow('',type));}
function collectModalData(){var data={titulo:gv('m-titulo'),intro:gv('m-intro'),imagen:gv('m-imagen'),badge:gv('m-badge'),servicios_titulo:gv('m-servicios_titulo'),temas_titulo:gv('m-temas_titulo'),cta_texto:gv('m-cta_texto'),cta_url:gv('m-cta_url'),modalidad:gv('m-modalidad')};for(var n=1;n<=20;n++){data['servicio_'+n]='';data['tema_'+n]='';}document.querySelectorAll('#m-svc-list input').forEach(function(inp,i){var v=inp.value.trim();if(v)data['servicio_'+(i+1)]=v;});document.querySelectorAll('#m-tema-list input').forEach(function(inp,i){var v=inp.value.trim();if(v)data['tema_'+(i+1)]=v;});return data;}
function saveCurrentModal(){if(saving)return;if(currentUser&&currentUser.rol==='viewer'){toast('Los visores no pueden guardar.','warn');return;}saving=true;setModalStatus('Guardando...','warn');apiPost(currentTab,collectModalData()).then(function(){setModalStatus('Guardado','ok');toast(currentTab+' guardado','ok');}).catch(function(e){setModalStatus('Error','err');toast('Error: '+e.message,'err');}).finally(function(){saving=false;});}
function updatePreview(){var titulo=gv('m-titulo')||'Titulo',intro=gv('m-intro')||'',imagen=gv('m-imagen')||'';var badge=gv('m-badge')||'',ctaTxt=gv('m-cta_texto')||'Contactar',ctaUrl=gv('m-cta_url')||'#';var svcTit=gv('m-servicios_titulo')||'Nuestros servicios:',temaTit=gv('m-temas_titulo')||'Temas:';var isEval=currentTab==='Evaluaciones';var svcs=Array.from(document.querySelectorAll('#m-svc-list input')).map(function(i){return i.value.trim();}).filter(Boolean);var temas=Array.from(document.querySelectorAll('#m-tema-list input')).map(function(i){return i.value.trim();}).filter(Boolean);var temasHTML=isEval?'<div style="display:grid;grid-template-columns:1fr 1fr;gap:.3rem;">'+temas.map(function(t){return'<div style="background:var(--mp);border-radius:5px;padding:.28rem .5rem;font-size:.7rem;font-weight:600;color:var(--mi);border-left:3px solid var(--mi);">'+esc(t)+'</div>';}).join('')+'</div>':'<ul style="padding-left:1.15rem;">'+temas.map(function(t){return'<li style="margin-bottom:.18rem;font-size:.8rem;">'+esc(t)+'</li>';}).join('')+'</ul>';document.getElementById('pv-head').textContent=titulo;var imgHtml='';if(imagen){var fid=extractFileId(imagen);var pvSrc=fid?('https://lh3.googleusercontent.com/d/'+fid):imagen;imgHtml='<img src="'+esc(pvSrc)+'" style="width:100%;max-height:150px;object-fit:cover;border-radius:7px;margin-bottom:.75rem;display:block;" onerror="this.style.display=\'none\'">';}document.getElementById('pv-body').innerHTML=imgHtml+(badge?'<span class="pb-badge">'+esc(badge)+'</span>':'')+(intro?'<p style="font-size:.8rem;margin-bottom:.45rem;">'+esc(intro)+'</p>':'')+(svcs.length?'<span class="pb-section">'+esc(svcTit)+'</span><ul style="padding-left:1.15rem;">'+svcs.map(function(s){return'<li style="margin-bottom:.18rem;font-size:.8rem;">'+esc(s)+'</li>';}).join('')+'</ul>':'')+(temas.length?'<span class="pb-section">'+esc(temaTit)+'</span>'+temasHTML:'')+'<a href="'+esc(ctaUrl)+'" class="pb-cta" target="_blank">'+esc(ctaTxt)+'</a>';}

/* â•â•â• PENDIENTES â•â•â• */
function parsePendientes(data){var rows=[],i=1;while(data['id_'+i]!==undefined){if(data['id_'+i]){rows.push({idx:i,id:data['id_'+i]||'',nombre:data['nombre_'+i]||'',telefono:data['telefono_'+i]||'',correo:data['correo_'+i]||'',servicio:data['servicio_'+i]||'',motivo:data['motivo_'+i]||'',tipo:data['tipo_'+i]||'',modal:data['modal_'+i]||'',sesion:data['sesion_'+i]||'',estado:data['estado_'+i]||'Pendiente',fecha_registro:data['fecha_registro_'+i]||'',fecha_cita:data['fecha_cita_'+i]||'',hora_cita:data['hora_cita_'+i]||'',nota_cita:data['nota_cita_'+i]||'',notificado:data['notificado_'+i]||''});}i++;}return rows;}
function loadPendientes(){var grid=document.getElementById('pend-grid'),loading=document.getElementById('pend-loading');grid.innerHTML='';loading.style.display='block';apiGet('Pendientes').then(function(data){pendientesData=parsePendientes(data);loading.style.display='none';actualizarContadores();renderPendientes();}).catch(function(e){loading.style.display='none';grid.innerHTML='<div class="pend-empty"><div class="pend-empty-ico">ğŸ“­</div><p>No se pudo cargar los pendientes.<br><small>'+esc(e.message)+'</small></p></div>';toast('Error cargando Pendientes: '+e.message,'err');});}
function contarPendientes(){apiGet('Pendientes').then(function(data){var rows=parsePendientes(data),n=rows.filter(function(r){return r.estado==='Pendiente';}).length,badge=document.getElementById('pend-nav-badge');if(badge){if(n>0){badge.textContent=n;badge.style.display='inline-block';}else{badge.style.display='none';}}}).catch(function(){});}
function actualizarContadores(){var total=pendientesData.length,pend=pendientesData.filter(function(r){return r.estado==='Pendiente';}).length,esp=pendientesData.filter(function(r){return r.estado==='En espera';}).length,conf=pendientesData.filter(function(r){return r.estado==='Confirmado';}).length,canc=pendientesData.filter(function(r){return r.estado==='Cancelado';}).length;setText('pf-todos',total);setText('pf-pendiente',pend);setText('pf-espera',esp);setText('pf-confirmado',conf);setText('pf-cancelado',canc);var badge=document.getElementById('pend-nav-badge');if(badge){if(pend>0){badge.textContent=pend;badge.style.display='inline-block';}else{badge.style.display='none';}}}
function filtrarPend(btn){document.querySelectorAll('.pend-filtro').forEach(function(b){b.classList.remove('on');});btn.classList.add('on');filtroActivo=btn.dataset.estado;renderPendientes();}
function renderPendientes(){var grid=document.getElementById('pend-grid');var lista=filtroActivo==='todos'?pendientesData:pendientesData.filter(function(r){return r.estado===filtroActivo;});if(!lista.length){grid.innerHTML='<div class="pend-empty" style="grid-column:1/-1;"><div class="pend-empty-ico">ğŸ“­</div><p>No hay registros en este estado.</p></div>';return;}grid.innerHTML=lista.map(function(r){var chipClass={'Pendiente':'chip-pendiente','En espera':'chip-espera','Confirmado':'chip-confirmado','Cancelado':'chip-cancelado'}[r.estado]||'chip-pendiente';var estadoEmoji={'Pendiente':'â³','En espera':'ğŸ”µ','Confirmado':'âœ…','Cancelado':'âŒ'}[r.estado]||'â³';var fechaStr=r.fecha_registro?new Date(r.fecha_registro).toLocaleDateString('es-MX',{day:'2-digit',month:'short',year:'numeric',hour:'2-digit',minute:'2-digit'}):'â€”';var citaInfo=r.fecha_cita?'<br>ğŸ“… Cita: <strong>'+esc(r.fecha_cita)+(r.hora_cita?' Â· '+esc(r.hora_cita):'')+'</strong>':'';return'<div class="pend-card" onclick="abrirAgenda('+r.idx+')">'+'<div class="pend-card-hdr">'+'<div><div class="pend-card-nombre">'+esc(r.nombre)+'</div><div class="pend-card-id">'+esc(r.id)+'</div></div>'+'<span class="pend-chip '+chipClass+'">'+estadoEmoji+' '+esc(r.estado)+'</span>'+'</div>'+'<div class="pend-card-body">'+'ğŸ“± <strong>'+esc(r.telefono)+'</strong> Â· ğŸ“§ '+esc(r.correo||'â€”')+'<br>'+'ğŸ·ï¸ <strong>'+esc(r.modal||r.servicio||'â€”')+'</strong>'+(r.motivo?'<br>ğŸ“ '+esc(r.motivo.substring(0,80))+(r.motivo.length>80?'â€¦':''):'')+ citaInfo+'</div>'+'<div class="pend-card-footer">'+'<span class="pend-card-ts">ğŸ• '+fechaStr+'</span>'+'<span style="font-size:.72rem;color:var(--mi);font-weight:600;">Ver agenda â†’</span>'+'</div>'+'</div>';}).join('');}

/* â•â•â• AGENDA â•â•â• */
function abrirAgenda(idx){var r=pendientesData.find(function(p){return p.idx===idx;});if(!r)return;pendienteActivo=r;slotActivo=null;setText('ag-nombre',r.nombre);setText('ag-tel',r.telefono);setText('ag-correo',r.correo||'â€”');setText('ag-servicio',r.modal||r.servicio||'â€”');setText('ag-motivo',r.motivo||'');document.getElementById('ag-motivo-wrap').style.display=r.motivo?'block':'none';var msgSug='Hola '+r.nombre.split(' ')[0]+', hemos recibido tu solicitud de '+(r.modal||r.servicio||'servicio')+'. En breve te confirmamos tu fecha de cita. Â¡Gracias por contactarnos! ğŸ’œ';document.getElementById('notif-msg-extra').value=msgSug;document.getElementById('ag-confirmar-btn').disabled=true;document.getElementById('agendaModal').classList.add('show');document.body.style.overflow='hidden';cargarSlots();}
function cerrarAgenda(){document.getElementById('agendaModal').classList.remove('show');document.body.style.overflow='';pendienteActivo=null;slotActivo=null;}
function cargarSlots(){var container=document.getElementById('ag-slots-container');container.innerHTML='<div class="slot-loading"><div class="slot-spinner"></div>Cargando disponibilidad...</div>';if(slotsCache&&(Date.now()-slotsCache.ts)<120000){renderSlots(slotsCache.slots);return;}apiGet('Disponibilidad').then(function(data){var slots=parseSlotsDisponibles(data);slotsCache={slots:slots,ts:Date.now()};renderSlots(slots);}).catch(function(e){container.innerHTML='<div style="text-align:center;color:var(--err);padding:1.5rem;font-size:.82rem;">âš ï¸ No se pudo cargar disponibilidad.<br><small>'+esc(e.message)+'</small></div>';});}
function parseSlotsDisponibles(data){var slots=[],i=1,hoy=new Date();hoy.setHours(0,0,0,0);while(data['fecha_'+i]!==undefined){var fechaStr=data['fecha_'+i]||'';if(fechaStr&&data['estado_'+i]!=='Ocupado'){var fecha=new Date(fechaStr+'T12:00:00');if(fecha>=hoy){slots.push({idx:i,fecha:fechaStr,dia:DIAS[fecha.getDay()],num:fecha.getDate(),mes:MESES[fecha.getMonth()],hora_inicio:data['hora_inicio_'+i]||'',hora_fin:data['hora_fin_'+i]||'',nota:data['nota_'+i]||'',estado:data['estado_'+i]||'Disponible'});}}i++;}return slots;}
function renderSlots(slots){var container=document.getElementById('ag-slots-container');if(!slots.length){container.innerHTML='<div style="text-align:center;color:var(--text2);padding:1.5rem;font-size:.82rem;">ğŸ“­ No hay horarios disponibles prÃ³ximamente.</div>';return;}var html='<div class="agenda-slots-grid">';slots.forEach(function(s,i){html+='<div class="agenda-slot" id="aslot-'+i+'" onclick="seleccionarSlot('+i+')">'+'<div class="asl-dia">'+esc(s.dia)+'</div>'+'<div class="asl-fecha">'+s.num+'</div>'+'<div class="asl-mes">'+esc(s.mes)+'</div>'+(s.hora_inicio?'<div class="asl-hora">'+esc(s.hora_inicio)+(s.hora_fin?'â€“'+esc(s.hora_fin):'')+'</div>':'')+'</div>';});html+='</div>';container.innerHTML=html;container._slots=slots;}
function seleccionarSlot(i){var container=document.getElementById('ag-slots-container');var slots=container._slots||(slotsCache?slotsCache.slots:[]);slotActivo=slots[i]||null;container.querySelectorAll('.agenda-slot').forEach(function(el){el.classList.remove('sel');});var el=container.querySelector('#aslot-'+i);if(el)el.classList.add('sel');document.getElementById('ag-confirmar-btn').disabled=!slotActivo;}
function confirmarCita(){if(!pendienteActivo||!slotActivo)return;var btn=document.getElementById('ag-confirmar-btn');btn.disabled=true;btn.textContent='Enviando...';var r=pendienteActivo,s=slotActivo;var msgExtra=document.getElementById('notif-msg-extra').value.trim();var envWA=document.getElementById('notif-wa').checked,envEmail=document.getElementById('notif-email').checked,envAdmin=document.getElementById('notif-admin').checked;var fechaLegible=s.dia+' '+s.num+' de '+s.mes,horaLegible=s.hora_inicio+(s.hora_fin?' â€“ '+s.hora_fin:'');var updateData={};updateData['estado_'+r.idx]='En espera';updateData['fecha_cita_'+r.idx]=s.fecha;updateData['hora_cita_'+r.idx]=s.hora_inicio;updateData['nota_cita_'+r.idx]=s.nota||'';updateData['notificado_'+r.idx]=new Date().toISOString();var slotUpdate={};slotUpdate['estado_'+s.idx]='Ocupado';slotUpdate['reservado_para_'+s.idx]=r.nombre+' â€” '+r.id;var promesas=[apiPost('Pendientes',updateData),apiPost('Disponibilidad',slotUpdate)];if(envEmail&&r.correo){promesas.push(apiAction('enviarCorreoSolicitud',{data:{nombre:r.nombre,telefono:r.telefono,correo:r.correo,servicio:r.modal||r.servicio,fecha:s.fecha,hora_inicio:s.hora_inicio,hora_fin:s.hora_fin||'',motivo:r.motivo||'',mensaje_extra:msgExtra}}).catch(function(){}));}Promise.all(promesas).then(function(){if(envWA&&r.telefono){var telCliente=r.telefono.replace(/\D/g,'');if(telCliente.length===10)telCliente='52'+telCliente;var msgCliente='Â¡Hola '+r.nombre.split(' ')[0]+'! ğŸ’œ\n\nTu solicitud de *'+(r.modal||r.servicio)+'* ha sido recibida.\nğŸ“… Fecha tentativa: *'+fechaLegible+'*\nğŸ• Horario: *'+horaLegible+'*\n\nTu cita queda en *estado: En espera* hasta confirmar disponibilidad definitiva.\n\n'+(msgExtra?msgExtra+'\n\n':'')+'Â¡Nos pondremos en contacto pronto! ğŸŒ¿';window.open('https://wa.me/'+telCliente+'?text='+encodeURIComponent(msgCliente),'_blank');}if(envAdmin){var msgAdmin='ğŸ“‹ *Cita agendada â€” En espera*\n\nğŸªª *ID:* '+r.id+'\nğŸ‘¤ *Paciente:* '+r.nombre+'\nğŸ“± *TelÃ©fono:* '+r.telefono+'\n'+(r.correo?'ğŸ“§ *Correo:* '+r.correo+'\n':'')+'ğŸ·ï¸ *Servicio:* '+(r.modal||r.servicio)+'\nğŸ“… *Fecha cita:* '+fechaLegible+'\nğŸ• *Horario:* '+horaLegible+'\n\n_Estado: En espera. Confirma con el paciente._';window.open('https://wa.me/'+WA_ADMIN+'?text='+encodeURIComponent(msgAdmin),'_blank');}var registro=pendientesData.find(function(p){return p.idx===r.idx;});if(registro){registro.estado='En espera';registro.fecha_cita=s.fecha;registro.hora_cita=s.hora_inicio;}actualizarContadores();renderPendientes();cerrarAgenda();toast('âœ… Cita agendada y notificaciones enviadas','ok');}).catch(function(e){btn.disabled=false;btn.textContent='ğŸ“¨ Confirmar y notificar';toast('Error al confirmar: '+e.message,'err');});}

/* â•â•â• USUARIOS â•â•â• */
function loadUsersPage(){document.getElementById('users-loading').style.display='block';document.getElementById('users-table').style.display='none';apiGet('Usuarios').then(function(data){usersData=parseUsers(data);renderUsersTable();document.getElementById('users-loading').style.display='none';document.getElementById('users-table').style.display='block';}).catch(function(e){toast('Error al cargar usuarios: '+e.message,'err');document.getElementById('users-loading').style.display='none';});}
function renderUsersTable(){var rL={admin:'Administrador',editor:'Editor',viewer:'Visor'},rC={admin:'role-admin',editor:'role-editor',viewer:'role-viewer'};var html='<table class="utbl"><thead><tr><th>Nombre</th><th>Login</th><th>Rol</th><th>Estado</th><th style="text-align:right;">Acciones</th></tr></thead><tbody>';if(!usersData.length)html+='<tr><td colspan="5" style="text-align:center;color:var(--text3);padding:2rem;">No hay usuarios.</td></tr>';usersData.forEach(function(u){var isMe=currentUser&&currentUser.login===u.login,isActive=u.activo==='true';html+='<tr><td><div style="display:flex;align-items:center;gap:.55rem;"><div style="width:28px;height:28px;border-radius:50%;background:var(--grad);display:flex;align-items:center;justify-content:center;color:#fff;font-size:.75rem;font-weight:700;flex-shrink:0;">'+esc(u.nombre.charAt(0).toUpperCase())+'</div><span style="font-weight:600;">'+esc(u.nombre)+(isMe?' <span style="color:var(--mi);font-size:.7rem;">(tÃº)</span>':'')+'</span></div></td><td style="font-family:var(--mono);font-size:.8rem;color:var(--text2);">'+esc(u.login)+'</td><td><span class="role-chip '+(rC[u.rol]||'')+'">'+( rL[u.rol]||u.rol)+'</span></td><td><span class="status-dot" style="background:'+(isActive?'var(--ok)':'var(--text3)')+'"></span><span style="font-size:.82rem;">'+(isActive?'Activo':'Inactivo')+'</span></td><td><div style="display:flex;gap:.35rem;justify-content:flex-end;"><button class="btn btn-ghost btn-sm" onclick="editUser('+u.idx+')">Editar</button>'+(!isMe?'<button class="btn btn-danger btn-sm" onclick="toggleUserActive('+u.idx+','+isActive+')">'+(isActive?'Desactivar':'Activar')+'</button>':'')+'</div></td></tr>';});html+='</tbody></table>';document.getElementById('users-table').innerHTML=html;}
function openUserModal(){['um-idx','um-nombre','um-login','um-pass'].forEach(function(id){document.getElementById(id).value='';});document.getElementById('um-rol').value='editor';document.getElementById('um-activo').checked=true;document.getElementById('um-pass-opt').textContent='';document.getElementById('um-title').textContent='ğŸ‘¤ Nuevo usuario';document.getElementById('um-strength').textContent='';document.getElementById('str-bar').style.width='0';document.getElementById('um-pass').type='password';document.getElementById('userModal').classList.add('show');}
function editUser(idx){var u=usersData.find(function(u){return u.idx===idx;});if(!u)return;document.getElementById('um-title').textContent='Editar: '+u.nombre;document.getElementById('um-idx').value=idx;document.getElementById('um-nombre').value=u.nombre;document.getElementById('um-login').value=u.login;document.getElementById('um-pass').value='';document.getElementById('um-rol').value=u.rol;document.getElementById('um-activo').checked=u.activo==='true';document.getElementById('um-pass-opt').textContent='dejar vacÃ­o para no cambiar';document.getElementById('um-strength').textContent='';document.getElementById('str-bar').style.width='0';document.getElementById('um-pass').type='password';document.getElementById('userModal').classList.add('show');}
function closeUserModal(){document.getElementById('userModal').classList.remove('show');}
function saveUser(){var idx=document.getElementById('um-idx').value,nombre=document.getElementById('um-nombre').value.trim(),login=document.getElementById('um-login').value.trim(),pass=document.getElementById('um-pass').value,rol=document.getElementById('um-rol').value,activo=document.getElementById('um-activo').checked?'true':'false';if(!nombre){toast('El nombre es obligatorio.','err');return;}if(!login){toast('El login es obligatorio.','err');return;}if(!/^[\w.]+$/.test(login)){toast('Login invalido: solo letras, numeros y punto.','err');return;}if(!idx&&!pass){toast('La contraseÃ±a es obligatoria para nuevos usuarios.','err');return;}if(pass&&pass.length<8){toast('La contraseÃ±a debe tener minimo 8 caracteres.','err');return;}var dup=usersData.find(function(u){return u.login===login&&String(u.idx)!==String(idx);});if(dup){toast('Ya existe un usuario con ese login.','err');return;}var userIdx=idx?parseInt(idx):(usersData.length>0?Math.max.apply(null,usersData.map(function(u){return u.idx;}))+1:1);var sd={};sd['login_'+userIdx]=login;sd['nombre_'+userIdx]=nombre;sd['rol_'+userIdx]=rol;sd['activo_'+userIdx]=activo;if(pass)sd['pass_'+userIdx]=pass;apiPost('Usuarios',sd).then(function(){closeUserModal();toast('Usuario guardado.','ok');loadUsersPage();}).catch(function(e){toast('Error: '+e.message,'err');});}
function toggleUserActive(idx,currently){var u=usersData.find(function(u){return u.idx===idx;});if(!u)return;if(!confirm((currently?'Desactivar':'Activar')+' al usuario "'+u.nombre+'"?'))return;var d={};d['activo_'+idx]=currently?'false':'true';apiPost('Usuarios',d).then(function(){toast('Usuario '+(currently?'desactivado':'activado')+'.','warn');loadUsersPage();}).catch(function(e){toast('Error: '+e.message,'err');});}
function checkPassStrength(){var pass=document.getElementById('um-pass').value,hint=document.getElementById('um-strength'),bar=document.getElementById('str-bar');if(!pass){hint.textContent='';bar.style.width='0';return;}var score=0;if(pass.length>=8)score++;if(pass.length>=12)score++;if(/[A-Z]/.test(pass))score++;if(/[0-9]/.test(pass))score++;if(/[^a-zA-Z0-9]/.test(pass))score++;var labels=['','Muy dÃ©bil','DÃ©bil','Regular','Fuerte','Muy fuerte'],colors=['','#ef4444','#f97316','#eab308','#22c55e','#16a34a'];hint.textContent='Seguridad: '+(labels[score]||'');hint.style.color=bar.style.background=colors[score]||'';bar.style.width=(score*20)+'%';}

/* â•â•â• UTILS â•â•â• */
function gv(id){var e=document.getElementById(id);return e?e.value.trim():'';}
function sv(id,val){var e=document.getElementById(id);if(e)e.value=val!=null?val:'';}
function setText(id,val){var e=document.getElementById(id);if(e)e.textContent=String(val!=null?val:'');}
function esc(s){return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');}
function toast(msg,type){var c=document.getElementById('toasts'),t=document.createElement('div');t.className='toast';t.style.borderLeftColor=type==='ok'?'var(--ok)':type==='err'?'var(--err)':'var(--warn)';t.textContent=msg;c.appendChild(t);setTimeout(function(){t.style.opacity='0';t.style.transform='translateX(44px)';t.style.transition='.28s';setTimeout(function(){t.remove();},320);},3500);}
if(!Promise.prototype.finally){Promise.prototype.finally=function(fn){return this.then(function(v){fn();return v;},function(e){fn();throw e;});};}

document.addEventListener('keydown',function(e){if(e.key==='Escape'){closeUserModal();cerrarAgenda();}});
document.getElementById('userModal').addEventListener('click',function(e){if(e.target===this)closeUserModal();});
document.getElementById('agendaModal').addEventListener('click',function(e){if(e.target===this)cerrarAgenda();});
</script>
</body>
</html>
