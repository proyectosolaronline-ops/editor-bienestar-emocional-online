<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Formularios Pendientes ‚Äî Bienestar Emocional</title>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@700;800&family=Manrope:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
:root{--rp:#FFE5F0;--ri:#FF85C0;--mp:#E8D5FF;--mi:#A67FFF;--card:#fff;--bg:#f5f2ff;--border:#ede8ff;--mid:#5A5570;--text:#2D2A3D;--ok:#22c55e;--err:#ef4444;--warn:#f59e0b;}
*{margin:0;padding:0;box-sizing:border-box;}
body{font-family:'Manrope',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;}
.topbar{background:var(--card);border-bottom:1px solid var(--border);padding:.8rem 1.4rem;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:200;box-shadow:0 2px 12px rgba(166,127,255,.08);}
.tb-l{display:flex;align-items:center;gap:.7rem;}
.tb-logo{width:34px;height:34px;border-radius:10px;background:linear-gradient(135deg,var(--ri),var(--mi));display:flex;align-items:center;justify-content:center;font-size:1rem;}
.tb-brand{font-family:'Syne',sans-serif;font-size:.95rem;font-weight:800;color:var(--text);}
.tb-brand span{color:var(--mi);}
.main{max-width:1100px;margin:0 auto;padding:1.5rem 1.2rem 3rem;}
.info-box{background:linear-gradient(135deg,rgba(166,127,255,.07),rgba(255,133,192,.05));border:1px solid rgba(166,127,255,.2);border-radius:10px;padding:.8rem 1rem;font-size:.82rem;color:var(--mid);margin-bottom:1.3rem;}
.info-box b{color:var(--mi);}
.filtros-bar{display:flex;gap:.5rem;flex-wrap:wrap;margin-bottom:1.2rem;align-items:center;}
.filtros-bar .sep{flex:1;}
.fchip{padding:.35rem 1rem;border-radius:50px;font-family:'Manrope',sans-serif;font-size:.78rem;font-weight:600;cursor:pointer;border:1.5px solid var(--border);background:#fff;color:var(--mid);white-space:nowrap;transition:all .18s;}
.fchip.on,.fchip:hover{background:linear-gradient(135deg,var(--ri),var(--mi));color:#fff;border-color:transparent;}
.fchip .n{opacity:.7;margin-left:3px;font-size:.72rem;}
.skel{background:linear-gradient(90deg,var(--border) 25%,var(--mp) 50%,var(--border) 75%);background-size:200% 100%;animation:sk 1.5s infinite;border-radius:16px;height:140px;margin-bottom:.8rem;}
@keyframes sk{0%{background-position:200% 0;}100%{background-position:-200% 0;}}
.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:1rem;}
.pcard{background:#fff;border:1.5px solid var(--border);border-radius:16px;overflow:hidden;cursor:pointer;transition:all .22s;}
.pcard:hover{transform:translateY(-3px);box-shadow:0 10px 32px rgba(166,127,255,.18);border-color:var(--mi);}
.pcard-top{padding:1rem 1.1rem .65rem;display:flex;align-items:flex-start;justify-content:space-between;gap:.5rem;}
.pcard-nombre{font-family:'Syne',sans-serif;font-size:.95rem;font-weight:700;}
.pcard-ref{font-size:.67rem;color:var(--mid);font-family:monospace;margin-top:2px;}
.pcard-body{padding:0 1.1rem .9rem;font-size:.82rem;color:var(--mid);line-height:1.65;}
.pcard-body strong{color:var(--text);font-weight:600;}
.pcard-footer{padding:.65rem 1.1rem;background:var(--bg);border-top:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;}
.pcard-ts{font-size:.7rem;color:var(--mid);}
.tbadge{display:inline-flex;align-items:center;padding:.15rem .6rem;border-radius:50px;font-size:.68rem;font-weight:700;}
.t-cita{background:#fdf4ff;color:#9333ea;}
.t-empresa{background:#eff6ff;color:#2563eb;}
.t-escuela{background:#f0fdf4;color:#16a34a;}
.empty{text-align:center;padding:5rem 1rem;color:var(--mid);grid-column:1/-1;}
.empty-ico{font-size:3rem;margin-bottom:.75rem;opacity:.35;}
.btn{display:inline-flex;align-items:center;justify-content:center;gap:.4rem;padding:.65rem 1.2rem;border-radius:50px;font-family:'Manrope',sans-serif;font-size:.84rem;font-weight:700;cursor:pointer;border:none;transition:all .2s;white-space:nowrap;}
.btn-primary{background:linear-gradient(135deg,var(--ri),var(--mi));color:#fff;box-shadow:0 4px 14px rgba(166,127,255,.35);}
.btn-primary:disabled{opacity:.5;cursor:not-allowed;}
.btn-ghost{background:transparent;color:var(--mid);border:1.5px solid var(--border);}
.btn-ghost:hover{border-color:var(--mi);color:var(--mi);}
.btn-sm{padding:.4rem .9rem;font-size:.78rem;}
.overlay{display:none;position:fixed;inset:0;z-index:5000;background:rgba(18,16,30,.75);backdrop-filter:blur(8px);}
.overlay.show{display:block;}
.modal{position:fixed;top:50%;left:50%;z-index:5001;background:var(--card);border-radius:20px;width:620px;max-width:96vw;max-height:92vh;overflow-y:auto;box-shadow:0 20px 60px rgba(0,0,0,.3);transform:translate(-50%,-50%) scale(.95);opacity:0;transition:transform .3s cubic-bezier(.16,1,.3,1),opacity .25s;pointer-events:none;}
.modal.show{transform:translate(-50%,-50%) scale(1);opacity:1;pointer-events:auto;}
.modal-head{padding:1.2rem 1.5rem 1rem;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;background:var(--card);z-index:2;}
.modal-title{font-family:'Syne',sans-serif;font-size:1.05rem;font-weight:800;}
.modal-close{background:none;border:none;font-size:1.3rem;cursor:pointer;color:var(--mid);line-height:1;}
.modal-body{padding:1.2rem 1.5rem 1.8rem;}
.sol-box{background:linear-gradient(135deg,rgba(232,213,255,.3),rgba(255,229,240,.2));border:1.5px solid var(--border);border-radius:12px;padding:1rem 1.2rem;margin-bottom:1.2rem;}
.sol-nombre{font-family:'Syne',sans-serif;font-size:1rem;font-weight:800;margin-bottom:.3rem;}
.sol-row{display:flex;flex-wrap:wrap;gap:.3rem .8rem;font-size:.8rem;color:var(--mid);margin-bottom:.3rem;}
.sol-motivo{font-size:.79rem;color:var(--mid);line-height:1.55;margin-top:.45rem;padding-top:.45rem;border-top:1px solid var(--border);}
.sol-extra-btn{font-size:.72rem;font-weight:700;color:var(--mi);background:none;border:none;cursor:pointer;font-family:'Manrope',sans-serif;margin-top:.5rem;padding:0;}
.sol-extra{display:none;margin-top:.5rem;background:rgba(245,242,255,.8);border-radius:8px;padding:.6rem .8rem;font-size:.75rem;color:var(--mid);line-height:1.8;}
.sol-extra.open{display:block;}
.divider{display:flex;align-items:center;gap:.6rem;margin:.9rem 0 .7rem;}
.divider span{font-size:.65rem;font-weight:700;color:var(--mid);text-transform:uppercase;letter-spacing:.1em;white-space:nowrap;}
.divider::before,.divider::after{content:'';flex:1;height:1px;background:var(--border);}
.tabs{display:flex;gap:.5rem;margin-bottom:1rem;}
.tab{flex:1;padding:.55rem;border-radius:10px;border:1.5px solid var(--border);background:#fff;font-family:'Manrope',sans-serif;font-size:.82rem;font-weight:700;cursor:pointer;color:var(--mid);transition:all .18s;text-align:center;}
.tab.on{background:linear-gradient(135deg,var(--ri),var(--mi));color:#fff;border-color:transparent;}
.slots-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:.55rem;max-height:210px;overflow-y:auto;padding:2px;margin-bottom:.8rem;}
.slot-card{background:linear-gradient(135deg,var(--rp),var(--mp));border:1.5px solid var(--border);border-radius:12px;padding:.7rem .5rem;text-align:center;cursor:pointer;transition:all .2s;}
.slot-card:hover,.slot-card.sel{background:linear-gradient(135deg,var(--ri),var(--mi));border-color:transparent;box-shadow:0 4px 14px rgba(166,127,255,.3);}
.slot-card:hover .sc-dia,.slot-card.sel .sc-dia,.slot-card:hover .sc-num,.slot-card.sel .sc-num,.slot-card:hover .sc-mes,.slot-card.sel .sc-mes,.slot-card:hover .sc-hora,.slot-card.sel .sc-hora{color:#fff!important;}
.sc-dia{font-size:.58rem;font-weight:700;color:var(--mid);text-transform:uppercase;letter-spacing:.07em;}
.sc-num{font-family:'Syne',sans-serif;font-size:1.2rem;font-weight:800;color:var(--text);line-height:1.1;}
.sc-mes{font-size:.62rem;color:var(--mid);}
.sc-hora{font-size:.7rem;font-weight:700;color:var(--mi);margin-top:.25rem;}
.slot-spinner{width:24px;height:24px;border:3px solid var(--mp);border-top-color:var(--mi);border-radius:50%;animation:sp .7s linear infinite;margin:1.5rem auto .5rem;}
@keyframes sp{to{transform:rotate(360deg);}}
.fg{margin-bottom:.85rem;}
.fg label{display:block;font-size:.68rem;font-weight:700;color:var(--mid);text-transform:uppercase;letter-spacing:.08em;margin-bottom:.35rem;}
input[type=date],input[type=time],select,textarea{width:100%;padding:.72rem .95rem;border:1.5px solid var(--border);border-radius:10px;font-family:'Manrope',sans-serif;font-size:.92rem;color:var(--text);background:#fafafa;outline:none;transition:all .2s;}
input:focus,select:focus,textarea:focus{border-color:var(--mi);background:#fff;box-shadow:0 0 0 3px rgba(166,127,255,.1);}
textarea{min-height:65px;resize:vertical;line-height:1.6;}
.g2{display:grid;grid-template-columns:1fr 1fr;gap:.7rem;}
.notif-box{background:#f8f5ff;border:1.5px solid var(--border);border-radius:12px;padding:.9rem 1rem;margin-bottom:1rem;}
.notif-title{font-size:.68rem;font-weight:700;color:var(--mid);text-transform:uppercase;letter-spacing:.08em;margin-bottom:.6rem;}
.notif-checks{display:flex;flex-direction:column;gap:.45rem;}
.ncheck{display:flex;align-items:flex-start;gap:.6rem;cursor:pointer;}
.ncheck input{width:15px;height:15px;margin-top:2px;accent-color:var(--mi);flex-shrink:0;}
.ncheck-txt{font-size:.81rem;color:var(--text);}
.ncheck-txt small{display:block;font-size:.71rem;color:var(--mid);margin-top:1px;}
.notif-msg{width:100%;margin-top:.6rem;padding:.65rem .9rem;border:1.5px solid var(--border);border-radius:10px;font-size:.82rem;font-family:'Manrope',sans-serif;color:var(--text);background:#fff;resize:vertical;min-height:60px;outline:none;transition:border .2s;}
.notif-msg:focus{border-color:var(--mi);}
.modal-actions{display:flex;gap:.7rem;margin-top:1.1rem;}
.modal-actions .btn{flex:1;}
.toasts{position:fixed;bottom:1.5rem;right:1.5rem;display:flex;flex-direction:column;gap:.5rem;z-index:9999;pointer-events:none;max-width:320px;}
.toast{background:#1e1b2e;color:#fff;padding:.8rem 1.2rem;border-radius:12px;font-size:.84rem;font-weight:600;display:flex;align-items:center;gap:.5rem;box-shadow:0 8px 28px rgba(0,0,0,.3);animation:tin .3s ease;}
@keyframes tin{from{opacity:0;transform:translateX(40px);}to{opacity:1;transform:none;}}
@media(max-width:600px){
  .modal{top:auto;bottom:0;left:0;right:0;width:100%;max-width:100%;max-height:92vh;border-radius:22px 22px 0 0;transform:translateY(100%);opacity:1;}
  .modal.show{transform:translateY(0);}
  .g2{grid-template-columns:1fr;}
  .modal-actions{flex-direction:column;}
}
</style>
</head>
<body>

<div class="topbar">
  <div class="tb-l">
    <div class="tb-logo">üìã</div>
    <div class="tb-brand">Formularios <span>pendientes</span></div>
  </div>
  <button class="btn btn-ghost btn-sm" onclick="cargar()">‚Ü∫ Recargar</button>
</div>

<div class="main">
  <div class="info-box">
    Formularios con estado <b>Pendiente</b> en <b>Citas_Personales</b>, <b>Cotizaciones_Empresas</b> y <b>Cotizaciones_Escuelas</b>. Haz clic para ver detalle y agendar respuesta.
  </div>

  <div class="filtros-bar">
    <button class="fchip on" data-tipo="todos"   onclick="filtrar(this)">Todos <span class="n" id="fn-todos">0</span></button>
    <button class="fchip"    data-tipo="cita"    onclick="filtrar(this)">üü£ Citas <span class="n" id="fn-cita">0</span></button>
    <button class="fchip"    data-tipo="empresa" onclick="filtrar(this)">üîµ Empresas <span class="n" id="fn-empresa">0</span></button>
    <button class="fchip"    data-tipo="escuela" onclick="filtrar(this)">üü¢ Escuelas <span class="n" id="fn-escuela">0</span></button>
    <div class="sep"></div>
  </div>

  <div id="loading"><div class="skel"></div><div class="skel"></div><div class="skel"></div></div>
  <div id="grid" class="grid" style="display:none;"></div>
</div>

<div class="overlay" id="overlay" onclick="cerrar()"></div>
<div class="modal"   id="modal"   onclick="event.stopPropagation()">
  <div class="modal-head">
    <div class="modal-title" id="m-title">üìã Detalle</div>
    <button class="modal-close" onclick="cerrar()">‚úï</button>
  </div>
  <div class="modal-body">

    <div class="sol-box">
      <div class="sol-nombre" id="m-nombre">‚Äî</div>
      <div class="sol-row">
        <span>üì± <span id="m-tel">‚Äî</span></span>
        <span>üìß <span id="m-correo">‚Äî</span></span>
        <span id="m-entidad-wrap" style="display:none;">üè¢ <span id="m-entidad">‚Äî</span></span>
      </div>
      <div class="sol-row">
        <span id="m-tipo-txt"></span>
        &nbsp;
        <span id="m-servicio-txt"></span>
      </div>
      <div class="sol-motivo" id="m-motivo-wrap" style="display:none;">üìù <span id="m-motivo"></span></div>
      <button class="sol-extra-btn" id="extra-btn" style="display:none;" onclick="toggleExtra()">+ Ver todos los datos</button>
      <div class="sol-extra" id="extra-fields"></div>
    </div>

    <div class="divider"><span>Agendar respuesta</span></div>

    <div class="tabs">
      <button class="tab on" id="tab-slots"  onclick="switchTab('slots')">üìÖ Horario disponible</button>
      <button class="tab"    id="tab-manual" onclick="switchTab('manual')">‚úèÔ∏è Fecha y hora manual</button>
    </div>

    <div id="panel-slots">
      <div id="slots-container">
        <div style="text-align:center;padding:1.2rem 0;color:var(--mid);font-size:.83rem;">
          <div class="slot-spinner"></div>Cargando disponibilidad‚Ä¶
        </div>
      </div>
    </div>

    <div id="panel-manual" style="display:none;">
      <div class="g2">
        <div class="fg"><label>Fecha</label><input type="date" id="man-fecha"></div>
        <div class="fg"><label>Hora inicio</label><input type="time" id="man-hora-ini" value="09:00"></div>
      </div>
      <div class="fg">
        <label>Hora fin <span style="font-weight:400;color:var(--mid);text-transform:none;font-size:.7rem;">(opcional)</span></label>
        <input type="time" id="man-hora-fin">
      </div>
    </div>

    <div class="fg" style="margin-top:.5rem;">
      <label>Estado a registrar</label>
      <select id="m-estado">
        <option value="En espera">üîµ En espera ‚Äî cita tentativa agendada</option>
        <option value="Atendido">‚úÖ Atendido ‚Äî completado</option>
        <option value="Cancelado">‚ùå Cancelado</option>
      </select>
    </div>

    <div class="notif-box">
      <div class="notif-title">üì§ Notificaciones</div>
      <div class="notif-checks">
        <label class="ncheck">
          <input type="checkbox" id="notif-wa" checked>
          <div class="ncheck-txt">WhatsApp al solicitante<small>Abre wa.me con mensaje prellenado</small></div>
        </label>
        <label class="ncheck">
          <input type="checkbox" id="notif-email" checked>
          <div class="ncheck-txt">Correo al solicitante<small>Env√≠a resumen v√≠a Apps Script</small></div>
        </label>
        <label class="ncheck">
          <input type="checkbox" id="notif-admin" checked>
          <div class="ncheck-txt">WhatsApp al administrador<small>Resumen de la cita agendada</small></div>
        </label>
      </div>
      <textarea class="notif-msg" id="notif-msg" placeholder="Mensaje adicional para el solicitante (opcional)‚Ä¶"></textarea>
    </div>

    <div class="modal-actions">
      <button class="btn btn-ghost" onclick="cerrar()">Cancelar</button>
      <button class="btn btn-primary" id="btn-confirmar" onclick="confirmar()" disabled>üì® Confirmar y notificar</button>
    </div>
  </div>
</div>

<div class="toasts" id="toasts"></div>

<script>
'use strict';
var PROXY    = 'https://script.google.com/macros/s/AKfycbz-_1X-c3aZ2lJ4N6m3R5tP2l2cznIs7Seuvkb5X5J1oPVrIXDwkEHi936b4dXg5JxO/exec';
var WA_ADMIN = '524425839311';
var DIAS  = ['Domingo','Lunes','Martes','Mi√©rcoles','Jueves','Viernes','S√°bado'];
var MESES = ['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];

var formularios  = [];
var filtroActivo = 'todos';
var reg          = null;
var slotSel      = null;
var slotsCache   = null;
var tabActiva    = 'slots';

cargar();

function apiGet(tab){
  return fetch(PROXY+'?tab='+encodeURIComponent(tab),{redirect:'follow'})
    .then(function(r){return r.text();})
    .then(function(t){var j=JSON.parse(t);if(!j.ok)throw new Error(j.error||'Error');return j;});
}
function apiPost(action,payload){
  return fetch(PROXY,{method:'POST',redirect:'follow',headers:{'Content-Type':'text/plain'},
    body:JSON.stringify(Object.assign({action:action},payload))})
    .then(function(r){return r.text();})
    .then(function(t){var j=JSON.parse(t);if(!j.ok)throw new Error(j.error||'Error');return j;});
}

function cargar(){
  document.getElementById('loading').style.display='';
  document.getElementById('grid').style.display='none';
  apiGet('FormulariosPendientes')
    .then(function(j){
      formularios=j.formularios||[];
      document.getElementById('loading').style.display='none';
      document.getElementById('grid').style.display='';
      actualizarContadores();
      renderGrid();
    })
    .catch(function(e){
      document.getElementById('loading').style.display='none';
      document.getElementById('grid').style.display='';
      document.getElementById('grid').innerHTML='<div class="empty"><div class="empty-ico">‚ö†Ô∏è</div><p>Error al cargar.<br><small>'+esc(e.message)+'</small></p></div>';
      toast('Error: '+e.message,'err');
    });
}

function actualizarContadores(){
  setText('fn-todos',  formularios.length);
  setText('fn-cita',   formularios.filter(function(f){return f._tipo==='cita';}).length);
  setText('fn-empresa',formularios.filter(function(f){return f._tipo==='empresa';}).length);
  setText('fn-escuela',formularios.filter(function(f){return f._tipo==='escuela';}).length);
}

function filtrar(btn){
  document.querySelectorAll('.fchip').forEach(function(b){b.classList.remove('on');});
  btn.classList.add('on');
  filtroActivo=btn.dataset.tipo;
  renderGrid();
}

function renderGrid(){
  var lista=filtroActivo==='todos'?formularios:formularios.filter(function(f){return f._tipo===filtroActivo;});
  var grid=document.getElementById('grid');
  if(!lista.length){
    grid.innerHTML='<div class="empty"><div class="empty-ico">üì≠</div><p>Sin formularios pendientes.</p></div>';
    return;
  }
  var tm={cita:['üü£','t-cita','Cita'],empresa:['üîµ','t-empresa','Empresa'],escuela:['üü¢','t-escuela','Escuela']};
  grid.innerHTML=lista.map(function(f){
    var t=tm[f._tipo]||['üìã','t-cita',f._tipo];
    var ts='';
    if(f.timestamp){try{ts=new Date(f.timestamp).toLocaleDateString('es-MX',{day:'2-digit',month:'short',year:'numeric'});}catch(e){ts=(f.timestamp||'').substring(0,10);}}
    var mot=f.motivo?esc(f.motivo.substring(0,85))+(f.motivo.length>85?'‚Ä¶':''):'';
    return '<div class="pcard" onclick="abrirModal(\''+esc(f._hoja)+'\','+Number(f._rowIndex)+')">'
      +'<div class="pcard-top"><div><div class="pcard-nombre">'+esc(f.nombre||'‚Äî')+'</div>'
      +'<div class="pcard-ref">'+esc(f._hoja)+' ¬∑ fila '+f._rowIndex+'</div></div>'
      +'<span class="tbadge '+t[1]+'">'+t[0]+' '+t[2]+'</span></div>'
      +'<div class="pcard-body">üì± <strong>'+esc(f.telefono||'‚Äî')+'</strong>'
      +(f.correo?' ¬∑ üìß '+esc(f.correo):'')
      +(f.entidad?'<br>üè¢ <strong>'+esc(f.entidad)+'</strong>':'')
      +(f.servicio?'<br>üè∑Ô∏è <strong>'+esc(f.servicio)+'</strong>':'')
      +(mot?'<br>üìù '+mot:'')+'</div>'
      +'<div class="pcard-footer"><span class="pcard-ts">üïê '+(ts||'‚Äî')+'</span>'
      +'<span style="font-size:.74rem;color:var(--mi);font-weight:600;">Ver detalle ‚Üí</span></div></div>';
  }).join('');
}

function abrirModal(hoja,rowIndex){
  var f=formularios.find(function(x){return x._hoja===hoja&&Number(x._rowIndex)===Number(rowIndex);});
  if(!f)return;
  reg=f;slotSel=null;
  var tm={cita:['üü£','Cita personal'],empresa:['üîµ','Empresa'],escuela:['üü¢','Escuela']};
  var t=tm[f._tipo]||['üìã',f._tipo];
  document.getElementById('m-title').textContent=t[0]+' '+(f.nombre||'Formulario');
  document.getElementById('m-nombre').textContent=f.nombre||'‚Äî';
  document.getElementById('m-tel').textContent=f.telefono||'‚Äî';
  document.getElementById('m-correo').textContent=f.correo||'‚Äî';
  var ew=document.getElementById('m-entidad-wrap');
  if(f.entidad){document.getElementById('m-entidad').textContent=f.entidad;ew.style.display='';}
  else ew.style.display='none';
  document.getElementById('m-tipo-txt').textContent=t[0]+' '+t[1];
  document.getElementById('m-servicio-txt').textContent=f.servicio?'üè∑Ô∏è '+f.servicio:'';
  var mw=document.getElementById('m-motivo-wrap');
  if(f.motivo){document.getElementById('m-motivo').textContent=f.motivo;mw.style.display='';}
  else mw.style.display='none';
  var excluir=['_tipo','_hoja','_rowIndex','nombre','telefono','correo','servicio','motivo','entidad','estado','nombre_contacto','nombre_empresa','nombre_escuela','id_contacto','timestamp'];
  var extras=Object.keys(f).filter(function(k){return excluir.indexOf(k)===-1&&f[k]&&String(f[k]).trim();});
  var ef=document.getElementById('extra-fields'),eb=document.getElementById('extra-btn');
  if(extras.length){
    ef.innerHTML=extras.map(function(k){return '<b>'+esc(k.replace(/_/g,' '))+':</b> '+esc(f[k])+'<br>';}).join('');
    eb.style.display='';ef.classList.remove('open');eb.textContent='+ Ver todos los datos';
  } else {ef.innerHTML='';eb.style.display='none';}
  var primer=(f.nombre||'').split(' ')[0];
  document.getElementById('notif-msg').value='Hola '+primer+', hemos recibido tu solicitud de '+(f.servicio||f.entidad||'servicio')+'. En breve te confirmamos tu cita. ¬°Gracias! üíú';
  document.getElementById('m-estado').value='En espera';
  document.getElementById('btn-confirmar').disabled=true;
  document.getElementById('man-fecha').value='';
  document.getElementById('man-hora-ini').value='09:00';
  document.getElementById('man-hora-fin').value='';
  switchTab('slots');
  document.getElementById('overlay').classList.add('show');
  document.getElementById('modal').classList.add('show');
  document.body.style.overflow='hidden';
  cargarSlots();
}

function cerrar(){
  document.getElementById('overlay').classList.remove('show');
  document.getElementById('modal').classList.remove('show');
  document.body.style.overflow='';
  reg=slotSel=null;
}

function toggleExtra(){
  var ef=document.getElementById('extra-fields'),btn=document.getElementById('extra-btn');
  var o=ef.classList.toggle('open');
  btn.textContent=o?'‚àí Ocultar datos extra':'+ Ver todos los datos';
}

function switchTab(name){
  tabActiva=name;
  document.getElementById('tab-slots').classList.toggle('on',name==='slots');
  document.getElementById('tab-manual').classList.toggle('on',name==='manual');
  document.getElementById('panel-slots').style.display=name==='slots'?'':'none';
  document.getElementById('panel-manual').style.display=name==='manual'?'':'none';
  validarConfirmar();
}

function cargarSlots(){
  var c=document.getElementById('slots-container');
  c.innerHTML='<div style="text-align:center;padding:1.2rem 0;color:var(--mid);font-size:.83rem;"><div class="slot-spinner"></div>Cargando disponibilidad‚Ä¶</div>';
  if(slotsCache&&(Date.now()-slotsCache.ts)<120000){renderSlots(slotsCache.slots);return;}
  apiGet('Disponibilidad')
    .then(function(j){
      var hoy=new Date();hoy.setHours(0,0,0,0);
      var lista=(j.slots||[]).filter(function(s){
        if(s.activo!=='true')return false;
        var fd=new Date(s.fecha+'T12:00:00');
        return !isNaN(fd)&&new Date(fd.getFullYear(),fd.getMonth(),fd.getDate())>=hoy;
      });
      lista.sort(function(a,b){return(a.fecha+(a.hora_inicio||'')).localeCompare(b.fecha+(b.hora_inicio||''));});
      slotsCache={slots:lista,ts:Date.now()};
      renderSlots(lista);
    })
    .catch(function(e){
      c.innerHTML='<div style="text-align:center;color:var(--err);padding:1.2rem;font-size:.83rem;">‚ö†Ô∏è No se pudo cargar disponibilidad.<br><small>'+esc(e.message)+'</small></div>';
    });
}

function renderSlots(lista){
  var c=document.getElementById('slots-container');
  if(!lista.length){
    c.innerHTML='<div style="text-align:center;color:var(--mid);padding:1.2rem;font-size:.83rem;">üì≠ Sin horarios disponibles pr√≥ximamente.</div>';
    return;
  }
  var html='<div class="slots-grid">';
  lista.forEach(function(s,i){
    var fd=new Date(s.fecha+'T12:00:00');
    html+='<div class="slot-card" id="sc-'+i+'" onclick="selSlot('+i+')">'
      +'<div class="sc-dia">'+DIAS[fd.getDay()]+'</div>'
      +'<div class="sc-num">'+fd.getDate()+'</div>'
      +'<div class="sc-mes">'+MESES[fd.getMonth()]+'</div>'
      +(s.hora_inicio?'<div class="sc-hora">'+esc(s.hora_inicio)+(s.hora_fin?'‚Äì'+esc(s.hora_fin):'')+'</div>':'')
      +'</div>';
  });
  html+='</div>';
  c.innerHTML=html;
  c._slots=lista;
}

function selSlot(i){
  var c=document.getElementById('slots-container');
  var lista=c._slots||(slotsCache?slotsCache.slots:[]);
  slotSel=lista[i]||null;
  c.querySelectorAll('.slot-card').forEach(function(el){el.classList.remove('sel');});
  var el=document.getElementById('sc-'+i);if(el)el.classList.add('sel');
  validarConfirmar();
}

function validarConfirmar(){
  var ok=tabActiva==='slots'?!!slotSel:!!document.getElementById('man-fecha').value;
  document.getElementById('btn-confirmar').disabled=!ok;
}
document.getElementById('man-fecha').addEventListener('input',validarConfirmar);

function confirmar(){
  if(!reg)return;
  var fechaStr,horaIni,horaFin,slotRowIndex;
  if(tabActiva==='slots'){
    if(!slotSel){toast('Selecciona un horario','warn');return;}
    fechaStr=slotSel.fecha;horaIni=slotSel.hora_inicio||'';horaFin=slotSel.hora_fin||'';slotRowIndex=slotSel.rowIndex;
  } else {
    fechaStr=document.getElementById('man-fecha').value;
    if(!fechaStr){toast('Ingresa una fecha','warn');return;}
    horaIni=document.getElementById('man-hora-ini').value||'';
    horaFin=document.getElementById('man-hora-fin').value||'';
    slotRowIndex=null;
  }
  var fd=new Date(fechaStr+'T12:00:00');
  var fechaLeg=DIAS[fd.getDay()]+' '+fd.getDate()+' de '+MESES[fd.getMonth()];
  var horaLeg=horaIni+(horaFin?' ‚Äì '+horaFin:'');
  var nuevoEst=document.getElementById('m-estado').value;
  var msgExtra=document.getElementById('notif-msg').value.trim();
  var envWA=document.getElementById('notif-wa').checked;
  var envEmail=document.getElementById('notif-email').checked;
  var envAdmin=document.getElementById('notif-admin').checked;
  var btn=document.getElementById('btn-confirmar');
  btn.disabled=true;
  btn.innerHTML='<span style="display:inline-block;width:13px;height:13px;border:2.5px solid rgba(255,255,255,.3);border-top-color:#fff;border-radius:50%;animation:sp .7s linear infinite;vertical-align:middle;margin-right:.35rem;"></span>Enviando‚Ä¶';
  var promesas=[apiPost('marcarFormularioAtendido',{tab:reg._hoja,rowIndex:reg._rowIndex,estado:nuevoEst,fechaCita:fechaStr,horaCita:horaIni})];
  if(slotRowIndex)promesas.push(apiPost('marcarSlotOcupado',{rowIndex:slotRowIndex,reservadoPara:(reg.nombre||'')+' ‚Äî '+reg._hoja+'#'+reg._rowIndex}));
  if(envEmail&&reg.correo)promesas.push(apiPost('enviarCorreoFormulario',{data:{nombre:reg.nombre||'',correo:reg.correo||'',servicio:reg.servicio||'',fecha:fechaLeg,hora_inicio:horaIni,hora_fin:horaFin,motivo:reg.motivo||'',mensaje_extra:msgExtra}}).catch(function(){}));
  Promise.all(promesas)
    .then(function(){
      if(envWA&&reg.telefono){
        var tel=reg.telefono.replace(/\D/g,'');if(tel.length===10)tel='52'+tel;
        var primer=(reg.nombre||'').split(' ')[0];
        var msgC='¬°Hola '+primer+'! üíú\n\nRecibimos tu solicitud de *'+(reg.servicio||reg.entidad||'servicio')+'*.\nüìÖ Fecha tentativa: *'+fechaLeg+'*\nüïê Horario: *'+horaLeg+'*\n\n'+(msgExtra?msgExtra+'\n\n':'')+'Estado: *'+nuevoEst+'*. Pronto confirmaremos. üåø';
        window.open('https://wa.me/'+tel+'?text='+encodeURIComponent(msgC),'_blank');
      }
      if(envAdmin){
        var tm2={cita:'Cita personal',empresa:'Empresa',escuela:'Escuela'};
        var msgA='üìã *Formulario atendido*\n\nüè∑Ô∏è *Tipo:* '+(tm2[reg._tipo]||reg._tipo)+'\nüë§ *Nombre:* '+(reg.nombre||'‚Äî')+'\nüì± *Tel:* '+(reg.telefono||'‚Äî')+'\n'+(reg.correo?'üìß *Correo:* '+reg.correo+'\n':'')+(reg.entidad?'üè¢ *Entidad:* '+reg.entidad+'\n':'')+'üè∑Ô∏è *Servicio:* '+(reg.servicio||'‚Äî')+'\nüìÖ *Fecha:* '+fechaLeg+'\nüïê *Hora:* '+horaLeg+'\nüìå *Estado:* '+nuevoEst;
        window.open('https://wa.me/'+WA_ADMIN+'?text='+encodeURIComponent(msgA),'_blank');
      }
      formularios=formularios.filter(function(x){return!(x._hoja===reg._hoja&&Number(x._rowIndex)===Number(reg._rowIndex));});
      slotsCache=null;actualizarContadores();renderGrid();cerrar();
      toast('‚úÖ Formulario atendido','ok');
    })
    .catch(function(e){btn.disabled=false;btn.textContent='üì® Confirmar y notificar';toast('Error: '+e.message,'err');});
}

function esc(s){return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');}
function setText(id,v){var e=document.getElementById(id);if(e)e.textContent=String(v!=null?v:'');}
function toast(msg,type){
  var c=document.getElementById('toasts'),t=document.createElement('div');
  t.className='toast';t.style.borderLeft='3px solid '+(type==='ok'?'var(--ok)':type==='err'?'var(--err)':'var(--warn)');
  t.textContent=msg;c.appendChild(t);
  setTimeout(function(){t.style.opacity='0';t.style.transform='translateX(40px)';t.style.transition='.3s';setTimeout(function(){t.remove();},350);},3500);
}
document.addEventListener('keydown',function(e){if(e.key==='Escape')cerrar();});
</script>
</body>
</html>
